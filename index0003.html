<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-M-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dulce Costo</title>

    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#fadadd" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- Estilos Generales y Variables de Color --- */
      :root {
        --color-crema: #fdf5e6; /* Crema de Vainilla */
        --color-rosa: #fadadd; /* Rosa Cuarzo */
        --color-menta: #e0f2f1; /* Verde Menta */
        --color-chocolate: #4e342e; /* Marrón Chocolate */
        --color-coral: #ffab91; /* Coral Suave (CTA) */
        --color-sombra: rgba(78, 52, 46, 0.15);
        --font-titulos: "Playfair Display", serif;
        --font-cuerpo: "Montserrat", sans-serif;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        font-family: var(--font-cuerpo);
        background-color: var(--color-crema);
        color: var(--color-chocolate);
        line-height: 1.6;
        display: flex;
        justify-content: center;
        align-items: center; /* Centrado vertical para el login */
        min-height: 100vh;
        padding: 20px;
      }

      .hidden {
        display: none !important;
      }

      /* --- Estilos de la Pantalla de Autenticación --- */
      #auth-container {
        width: 100%;
        max-width: 400px;
        background-color: #fff;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 8px 30px var(--color-sombra);
        text-align: center;
      }
      #auth-container h2 {
        font-family: var(--font-titulos);
        font-size: 2em;
        margin-bottom: 25px;
      }
      #auth-container .form-group {
        text-align: left;
        margin-bottom: 15px;
      }
      #auth-container input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      .auth-btn {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        margin-top: 10px;
        transition: background-color 0.3s;
      }
      #login-btn {
        background-color: var(--color-chocolate);
        color: white;
      }
      #signup-btn {
        background-color: #eee;
        color: var(--color-chocolate);
      }
      #google-signin-btn {
        background-color: #fff;
        color: #444;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }
      #google-signin-btn:hover {
        background-color: #f5f5f5;
      }
      #auth-error {
        color: #c62828;
        margin-top: 15px;
        font-size: 0.9em;
        min-height: 1.2em;
      }

      /* --- Estilos de la Aplicación Principal --- */
      #app-container {
        width: 100%;
        max-width: 900px;
        background-color: #ffffff;
        border-radius: 16px;
        box-shadow: 0 8px 30px var(--color-sombra);
        overflow: hidden;
      }
      header {
        background-color: var(--color-rosa);
        padding: 20px;
        text-align: center;
        border-bottom: 2px solid var(--color-chocolate);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        font-family: var(--font-titulos);
        font-size: 2.5em;
      }
      #logout-btn {
        background-color: var(--color-chocolate);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 8px;
        cursor: pointer;
      }
      main {
        padding: 25px;
      }

      /* --- Estilos del Asistente de Costeo --- */
      .step-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
      }
      #calculator-wizard h2 {
        margin-bottom: 0;
      }
      .wizard-step {
        animation: fadeIn 0.5s ease-in-out;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group-inline {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }
      input[type="text"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-family: var(--font-cuerpo);
      }
      textarea {
        min-height: 80px;
        resize: vertical;
      }
      .dynamic-list-header {
        display: grid;
        gap: 10px;
        padding: 8px 10px;
        margin-bottom: 10px;
        background-color: var(--color-menta);
        border-radius: 8px;
      }
      .dynamic-list-header span {
        font-weight: 600;
        font-size: 0.9em;
        color: var(--color-chocolate);
        text-align: left;
      }
      #ingredients-list.dynamic-list .row,
      #labor-list.dynamic-list .row {
        display: grid;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
      }
      .row .input-group {
        display: flex;
        gap: 5px;
      }
      .delete-row-btn {
        background: #ffcdd2;
        color: #c62828;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        font-weight: bold;
        cursor: pointer;
        margin-left: auto;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      @media (max-width: 768px) {
        .dynamic-list-header {
          display: none;
        }
        #ingredients-list.dynamic-list .row {
          grid-template-columns: 1fr;
          gap: 15px;
          border: 1px solid var(--color-rosa);
          padding: 15px;
          border-radius: 12px;
        }
        .row .input-group {
          flex-wrap: wrap;
        }
        .row > div[data-label]::before {
          content: attr(data-label);
          display: block;
          font-weight: 500;
          margin-bottom: 5px;
          font-size: 0.9em;
        }
        .delete-row-btn {
          justify-self: center;
        }
      }
      .add-row-btn {
        background-color: var(--color-menta);
        border: 1px dashed var(--color-chocolate);
        color: var(--color-chocolate);
        padding: 10px;
        width: 100%;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
      }
      .wizard-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
      }
      .wizard-btn {
        background-color: var(--color-chocolate);
        color: white;
        font-weight: 600;
        padding: 12px 25px;
        border-radius: 8px;
        cursor: pointer;
        border: none;
      }
      .wizard-btn.prev {
        background-color: #eee;
        color: #333;
      }
      #dashboard .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 30px;
        align-items: center;
      }
      .search-container {
        flex-grow: 1;
      }
      #search-recipe {
        width: 100%;
      }
      #new-cost-btn {
        background-color: var(--color-coral);
        color: var(--color-chocolate);
        font-weight: 600;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        border: none;
        transition: background-color 0.3s ease;
      }
      #new-cost-btn:hover {
        background-color: #ff8a65;
      }
      #recipes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 20px;
      }
      .recipe-card {
        background-color: var(--color-menta);
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .recipe-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 20px var(--color-sombra);
      }
      .recipe-card img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .recipe-card h3 {
        font-family: var(--font-titulos);
        margin-bottom: 10px;
      }
      #summary-content {
        background: var(--color-menta);
        padding: 20px;
        border-radius: 12px;
      }
      .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ccc;
      }
      .summary-total {
        font-weight: bold;
        font-size: 1.4em;
        margin-top: 15px;
        color: var(--color-chocolate);
      }
      .modal-wrapper {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
        animation: fadeIn 0.3s ease;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 16px;
        width: 100%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }
      .modal-header h2 {
        font-family: var(--font-titulos);
        font-size: 1.8em;
      }
      .close-modal-btn {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
      }
      .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
      }
      .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      #edit-recipe-btn {
        background-color: var(--color-chocolate);
        color: white;
      }
      #delete-recipe-btn {
        background-color: #e53935;
        color: white;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="auth-container">
      <h2>Bienvenida a Dulce Costo</h2>
      <div class="form-group">
        <label for="email">Correo Electrónico</label
        ><input type="email" id="email" placeholder="tu@correo.com" />
      </div>
      <div class="form-group">
        <label for="password">Contraseña</label
        ><input type="password" id="password" placeholder="••••••••" />
      </div>
      <button id="login-btn" class="auth-btn">Iniciar Sesión</button>
      <button id="signup-btn" class="auth-btn">Registrarse</button>
      <p style="margin: 15px 0; font-size: 0.9em">o</p>
      <button id="google-signin-btn" class="auth-btn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          x="0px"
          y="0px"
          width="20"
          height="20"
          viewBox="0 0 48 48"
        >
          <path
            fill="#FFC107"
            d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
          ></path>
          <path
            fill="#FF3D00"
            d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
          ></path>
          <path
            fill="#4CAF50"
            d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.617-3.356-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
          ></path>
          <path
            fill="#1976D2"
            d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"
          ></path>
        </svg>
        >Continuar con Google
      </button>
      <p id="auth-error"></p>
    </div>

    <div id="app-container" class="hidden">
      <header>
        <h1>Dulce Costo.</h1>
        <button id="logout-btn">Cerrar Sesión</button>
      </header>
      <main>
        <section id="dashboard">
          <div class="controls">
            <div class="search-container">
              <input
                type="text"
                id="search-recipe"
                list="recipe-datalist"
                placeholder="Buscar una receta..."
              /><datalist id="recipe-datalist"></datalist>
            </div>
            <button
              id="import-from-code-btn"
              class="wizard-btn prev"
              style="margin-right: 10px"
            >
              Usar Código
            </button>
            <button id="manage-ingredients-btn" class="wizard-btn prev">
              Ingredientes
            </button>
            <button id="new-cost-btn">+ Crear Nuevo Costeo</button>
          </div>
          <h2>Mis Recetas</h2>
          <div id="recipes-grid"></div>
        </section>
        <section id="calculator-wizard" class="hidden">
          <div id="step-1" class="wizard-step">
            <h2>Paso 1: ¿Qué delicia vamos a costear?</h2>
            <div class="form-group">
              <label for="product-name">Nombre del Producto</label>
              <input
                type="text"
                id="product-name"
                placeholder="Ej: Torta de Zanahoria"
              />
            </div>
            <div class="form-group form-group-inline">
              <div>
                <label for="yield-quantity">Rendimiento Original</label>
                <input type="number" id="yield-quantity" placeholder="Ej: 12" />
              </div>
              <div>
                <label for="yield-unit">Unidad</label>
                <input
                  type="text"
                  id="yield-unit"
                  placeholder="Ej: porciones, kg"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="product-description">Descripción (Opcional)</label>
              <textarea
                id="product-description"
                placeholder="Añade detalles sobre tu producto"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="product-image">Foto del Producto (URL)</label>
              <input
                type="text"
                id="product-image"
                placeholder="Pega aquí la URL de una imagen"
              />
            </div>
          </div>
          <div id="step-2" class="wizard-step hidden">
            <div class="step-header">
              <h2>Paso 2: Materia Prima</h2>
            </div>
            <div
              class="dynamic-list-header"
              style="grid-template-columns: 4fr 3fr 30px"
            >
              <span>Ingrediente</span><span>Cantidad en Receta</span>
            </div>
            <div id="ingredients-list" class="dynamic-list">
              <!-- Las filas de ingredientes de la receta se añadirán aquí -->
            </div>
            <button class="add-row-btn" id="add-ingredient-btn">
              + Agregar Ingrediente
            </button>
          </div>

          <div id="step-3" class="wizard-step hidden">
            <h2>Paso 3: Mano de Obra (Tu tiempo vale oro)</h2>
            <div
              class="dynamic-list-header"
              style="grid-template-columns: 3fr 2fr 2fr 30px"
            >
              <span>Tarea / Empleado</span><span>Salario por Hora</span
              ><span>Tiempo (min)</span>
            </div>
            <div id="labor-list" class="dynamic-list"></div>
            <button class="add-row-btn" id="add-labor-btn">
              + Agregar Tarea/Empleado
            </button>
          </div>
          <div id="step-4" class="wizard-step hidden">
            <h2>Paso 4: Costos Indirectos (Gastos del taller)</h2>
            <div class="form-group">
              <label for="indirect-cost-rate">Costo Indirecto por Hora</label
              ><input
                type="number"
                id="indirect-cost-rate"
                placeholder="Calcula y define tu costo por hora"
              />
            </div>
            <div class="form-group">
              <label for="total-production-time"
                >Tiempo Total de Elaboración (en minutos)</label
              ><input
                type="number"
                id="total-production-time"
                placeholder="El tiempo total para producir esta receta"
              />
            </div>
          </div>
          <div id="step-5" class="wizard-step hidden">
            <h2>Paso 5: ¡El Resultado!</h2>
            <div id="summary-content"></div>
            <div class="form-group" style="margin-top: 20px">
              <label for="profit-margin">Margen de Ganancia (%)</label
              ><input type="number" id="profit-margin" value="50" min="0" />
            </div>
            <div class="summary-item summary-total">
              <span>Precio de Venta Sugerido</span
              ><span id="suggested-price-summary">$0.00</span>
            </div>
          </div>
          <div class="wizard-navigation">
            <button id="prev-btn" class="wizard-btn prev hidden">
              Anterior</button
            ><button id="next-btn" class="wizard-btn">Siguiente</button
            ><button id="save-btn" class="wizard-btn hidden">
              Guardar Receta
            </button>
          </div>
        </section>
      </main>
    </div>

    <div id="recipe-modal" class="modal-wrapper hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modal-title"></h2>
          <button class="close-modal-btn">&times;</button>
        </div>
        <div id="modal-body"></div>
        <div class="modal-footer">
          <button id="share-recipe-btn" class="modal-btn prev">
            Compartir
          </button>
          <button id="delete-recipe-btn" class="modal-btn">Eliminar</button
          ><button id="edit-recipe-btn" class="modal-btn">Editar Receta</button>
        </div>
      </div>
    </div>

    <div id="ingredients-db-modal" class="modal-wrapper hidden">
      <div class="modal-content" style="max-width: 800px">
        <div class="modal-header">
          <h2>Base de Datos de Ingredientes</h2>
          <button class="close-modal-btn">&times;</button>
        </div>
        <div id="ingredients-db-body">
          <p style="margin-bottom: 20px; font-size: 0.9em">
            Aquí gestionas todos tus ingredientes. Añade un ingrediente una sola
            vez con su precio y conversiones, y luego solo úsalo en tus recetas.
          </p>
          <!-- Formulario para Añadir/Editar -->
          <form
            id="ingredient-db-form"
            class="hidden"
            style="
              background: var(--color-menta);
              padding: 15px;
              border-radius: 12px;
              margin-bottom: 25px;
            "
          >
            <h3
              id="ingredient-form-title"
              style="margin-bottom: 15px; font-family: var(--font-cuerpo)"
            >
              Añadir Nuevo Ingrediente
            </h3>
            <div
              style="
                display: grid;
                grid-template-columns: 2fr 0.5fr 1fr 1fr 0.5fr 1fr 1fr; /* Define 7 columnas */
                gap: 10px;
                align-items: flex-end; /* Alinea los elementos abajo */
              "
            >
              <div class="form-group" style="margin: 0">
                <label>Ingrediente</label>
                <input type="text" id="db-ingredient-name" required />
              </div>
              <div class="form-group" style="margin: 0">
                <label>Moneda</label>
                <select
                  id="db-ingredient-currency"
                  style="width: 3rem; padding: 10px 5px"
                ></select>
              </div>
              <div class="form-group" style="margin: 0">
                <label>Precio</label>
                <input
                  type="number"
                  id="db-ingredient-price"
                  step="0.01"
                  required
                />
              </div>
              <div class="form-group" style="margin: 0">
                <label>Cant.</label>
                <input
                  type="number"
                  id="db-ingredient-qty"
                  step="0.01"
                  required
                />
              </div>
              <div class="form-group" style="margin: 0">
                <label>Unidad</label>
                <select
                  id="db-ingredient-unit"
                  style="width: 3rem; padding: 10px 5px"
                ></select>
              </div>
              <div class="form-group" style="margin: 0">
                <label>g / taza</label>
                <input
                  type="number"
                  id="db-ingredient-cup"
                  step="0.01"
                  placeholder="Ej: 120"
                />
              </div>
              <div class="form-group" style="margin: 0">
                <label>g / cda</label>
                <input
                  type="number"
                  id="db-ingredient-tbsp"
                  step="0.01"
                  placeholder="Ej: 8"
                />
              </div>
            </div>

            <div
              style="
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
              "
            >
              <button
                type="button"
                id="cancel-edit-ingredient-btn"
                class="wizard-btn prev"
              >
                Cancelar
              </button>
              <button type="submit" class="wizard-btn">
                Guardar Ingrediente
              </button>
            </div>
          </form>

          <button
            id="show-ingredient-form-btn"
            class="add-row-btn"
            style="margin-bottom: 20px"
          >
            + Añadir Ingrediente
          </button>

          <!-- Tabla de Ingredientes -->
          <div style="max-height: 40vh; overflow-y: auto">
            <table
              style="width: 100%; border-collapse: collapse; font-size: 0.9em"
            >
              <thead>
                <tr
                  style="text-align: left; background-color: var(--color-menta)"
                >
                  <th style="padding: 10px">Ingrediente</th>
                  <th style="padding: 10px">Precio Empaque</th>
                  <th style="padding: 10px">g / taza</th>
                  <th style="padding: 10px">g / cda</th>
                  <th style="padding: 10px">Acciones</th>
                </tr>
              </thead>
              <tbody id="ingredients-db-table-body">
                <!-- Los ingredientes se listarán aquí -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        addDoc,
        deleteDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      const firebaseConfig = {
        apiKey: "AIzaSyB_Rc2wPwhqMzCQUzDexn4LpGTtr6LWZAs",
        authDomain: "melangie-42568.firebaseapp.com",
        projectId: "melangie-42568",
        storageBucket: "melangie-42568.firebasestorage.app",
        messagingSenderId: "109387978959",
        appId: "1:109387978959:web:2eaa19b9cbae0cd310ffba",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      document.addEventListener("DOMContentLoaded", () => {
        let currentStep = 1,
          totalSteps = 5,
          editingRecipeId = null,
          recipes = [],
          currentUser = null;
        let ingredientsDB = {}; // Objeto para la nueva DB de ingredientes
        let editingIngredientKey = null; // Para saber si estamos editando

        const authContainer = document.getElementById("auth-container"),
          appContainer = document.getElementById("app-container"),
          dashboardView = document.getElementById("dashboard"),
          calculatorView = document.getElementById("calculator-wizard"),
          newCostBtn = document.getElementById("new-cost-btn"),
          prevBtn = document.getElementById("prev-btn"),
          nextBtn = document.getElementById("next-btn"),
          saveBtn = document.getElementById("save-btn"),
          recipeModal = document.getElementById("recipe-modal"),
          ingredientsDbModal = document.getElementById("ingredients-db-modal"),
          ingredientsList = document.getElementById("ingredients-list");

        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            authContainer.classList.add("hidden");
            appContainer.classList.remove("hidden");
            document.querySelector("body").style.alignItems = "flex-start";
            initApp();
          } else {
            currentUser = null;
            authContainer.classList.remove("hidden");
            appContainer.classList.add("hidden");
            document.querySelector("body").style.alignItems = "center";
          }
        });
        const emailInput = document.getElementById("email"),
          passwordInput = document.getElementById("password"),
          authError = document.getElementById("auth-error");
        document
          .getElementById("signup-btn")
          .addEventListener("click", async () => {
            try {
              await createUserWithEmailAndPassword(
                auth,
                emailInput.value,
                passwordInput.value
              );
              authError.textContent = "";
            } catch (error) {
              authError.textContent = "Error: " + error.code;
            }
          });
        document
          .getElementById("login-btn")
          .addEventListener("click", async () => {
            try {
              await signInWithEmailAndPassword(
                auth,
                emailInput.value,
                passwordInput.value
              );
              authError.textContent = "";
            } catch (error) {
              authError.textContent = "Error: " + error.code;
            }
          });
        document
          .getElementById("google-signin-btn")
          .addEventListener("click", async () => {
            try {
              await signInWithPopup(auth, provider);
              authError.textContent = "";
            } catch (error) {
              authError.textContent = "Error con Google: " + error.code;
            }
          });
        document
          .getElementById("logout-btn")
          .addEventListener("click", async () => {
            await signOut(auth);
          });

        // ===== INICIO FUNCIONES RESTAURADAS =====
        const shareRecipe = async (recipeId) => {
          const recipe = recipes.find((r) => r.id === recipeId);
          if (!recipe) {
            alert("No se encontró la receta para compartir.");
            return;
          }
          const recipeToShare = { ...recipe };
          delete recipeToShare.id;
          try {
            const docRef = await addDoc(
              collection(db, "shared_recipes"),
              recipeToShare
            );
            const shareCode = docRef.id;
            prompt(
              "¡Receta lista para compartir! Copia este código y envíalo:",
              shareCode
            );
          } catch (error) {
            console.error("Error al compartir la receta: ", error);
            alert("Hubo un error al intentar compartir la receta.");
          }
        };

        const importRecipeByCode = async () => {
          const code = prompt(
            "Introduce el código de la receta que quieres importar:"
          );
          if (!code || code.trim() === "") {
            return;
          }
          try {
            const docRef = doc(db, "shared_recipes", code.trim());
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
              const recipeData = docSnap.data();
              await addDoc(
                collection(db, "users", currentUser.uid, "recipes"),
                recipeData
              );
              alert(`¡Receta "${recipeData.name}" importada con éxito!`);
              await loadInitialData();
              renderRecipes();
            } else {
              alert(
                "Código no válido. No se encontró ninguna receta para importar."
              );
            }
          } catch (error) {
            console.error("Error al importar por código: ", error);
            alert(
              "Hubo un error al importar. Verifica que el código sea correcto."
            );
          }
        };
        // ===== FIN FUNCIONES RESTAURADAS =====

        const initApp = async () => {
          if (!currentUser) return;
          await loadInitialData();
          showView("dashboard");
        };

        const loadInitialData = async () => {
          if (!currentUser) return;

          const ingredientsRef = doc(
            db,
            "users",
            currentUser.uid,
            "data",
            "ingredients_master"
          );
          const ingredientsSnap = await getDoc(ingredientsRef);
          if (ingredientsSnap.exists()) {
            ingredientsDB = ingredientsSnap.data();
          } else {
            ingredientsDB = {};
          }
          renderIngredientsTable();

          const recipesCollectionRef = collection(
            db,
            "users",
            currentUser.uid,
            "recipes"
          );
          const querySnapshot = await getDocs(recipesCollectionRef);
          recipes = [];
          querySnapshot.forEach((doc) => {
            recipes.push({ id: doc.id, ...doc.data() });
          });
        };

        const saveRecipe = async () => {
          if (!currentUser) return alert("Debes iniciar sesión para guardar.");
          const { ingredientsCost, laborCost, indirectCost, totalCost } =
            calculateAllCosts();
          const profitMargin =
            parseFloat(document.getElementById("profit-margin").value) || 0;

          const recipeData = {
            name:
              document.getElementById("product-name").value ||
              "Receta sin nombre",
            description: document.getElementById("product-description").value,
            image: document.getElementById("product-image").value,
            yieldInfo: {
              quantity:
                parseFloat(document.getElementById("yield-quantity").value) ||
                1,
              unit: document.getElementById("yield-unit").value || "unidad",
            },
            ingredients: [],
            labor: [],
            indirectCostRate:
              parseFloat(document.getElementById("indirect-cost-rate").value) ||
              0,
            totalProductionTime:
              parseFloat(
                document.getElementById("total-production-time").value
              ) || 0,
            ingredientsCost,
            laborCost,
            indirectCost,
            totalCost,
            profitMargin,
            sellPrice: totalCost * (1 + profitMargin / 100),
          };

          document.querySelectorAll("#ingredients-list .row").forEach((row) => {
            const nameKey = row.querySelector(".ingredient-selector").value;
            if (nameKey) {
              recipeData.ingredients.push({
                name: nameKey,
                recipeQty: row.querySelector(".recipe-qty").value,
                recipeUnit: row.querySelector(".recipe-unit").value,
              });
            }
          });
          document.querySelectorAll("#labor-list .row").forEach((row) => {
            recipeData.labor.push({
              task: row.querySelector(".labor-task").value,
              currency: row.querySelector(".currency").value,
              rate: row.querySelector(".labor-rate").value,
              time: row.querySelector(".labor-time").value,
            });
          });

          try {
            if (editingRecipeId) {
              await setDoc(
                doc(db, "users", currentUser.uid, "recipes", editingRecipeId),
                recipeData
              );
              alert("¡Receta actualizada!");
            } else {
              await addDoc(
                collection(db, "users", currentUser.uid, "recipes"),
                recipeData
              );
              alert("¡Receta guardada con éxito!");
            }
            await loadInitialData();
            showView("dashboard");
          } catch (error) {
            console.error("Error al guardar: ", error);
          }
        };

        const deleteRecipe = async (recipeId) => {
          if (!currentUser) return;
          const recipe = recipes.find((r) => r.id === recipeId);
          if (!confirm(`¿Seguro que quieres eliminar "${recipe.name}"?`))
            return;
          try {
            await deleteDoc(
              doc(db, "users", currentUser.uid, "recipes", recipeId)
            );
            alert("¡Receta eliminada!");
            recipeModal.classList.add("hidden");
            await loadInitialData();
            renderRecipes();
          } catch (error) {
            console.error("Error al eliminar:", error);
          }
        };

        const showView = (view) => {
          if (view === "dashboard") {
            dashboardView.classList.remove("hidden");
            calculatorView.classList.add("hidden");
            renderRecipes();
          } else if (view === "calculator") {
            dashboardView.classList.add("hidden");
            calculatorView.classList.remove("hidden");
            if (!editingRecipeId) {
              resetCalculator();
            }
            updateWizard();
          }
        };

        const updateWizard = () => {
          document
            .querySelectorAll(".wizard-step")
            .forEach((step) => step.classList.add("hidden"));
          document
            .getElementById(`step-${currentStep}`)
            .classList.remove("hidden");
          prevBtn.classList.toggle("hidden", currentStep === 1);
          nextBtn.classList.toggle("hidden", currentStep === totalSteps);
          saveBtn.classList.toggle("hidden", currentStep !== totalSteps);
          if (currentStep === totalSteps) {
            generateSummary();
          }
        };

        const resetCalculator = () => {
          currentStep = 1;
          editingRecipeId = null;
          document.getElementById("product-name").value = "";
          document.getElementById("product-description").value = "";
          document.getElementById("product-image").value = "";
          document.getElementById("yield-quantity").value = "";
          document.getElementById("yield-unit").value = "";
          document.getElementById("indirect-cost-rate").value = "";
          document.getElementById("total-production-time").value = "";
          document.getElementById("profit-margin").value = "50";
          ingredientsList.innerHTML = "";
          document.getElementById("labor-list").innerHTML = "";
          addIngredientRow();
          addLaborRow();
          updateWizard();
        };

        const renderRecipes = () => {
          const grid = document.getElementById("recipes-grid");
          const datalist = document.getElementById("recipe-datalist");
          grid.innerHTML = "";
          datalist.innerHTML = "";
          if (recipes.length === 0) {
            grid.innerHTML =
              "<p>Aún no has creado ningún costeo. ¡Crea el primero!</p>";
            return;
          }
          recipes.forEach((recipe) => {
            const card = document.createElement("div");
            card.className = "recipe-card";
            card.dataset.id = recipe.id;
            card.innerHTML = `<img src="${
              recipe.image ||
              "https://placehold.co/300x200/FADADD/4E342E?text=Postre"
            }" alt="${recipe.name}"><h3>${
              recipe.name
            }</h3><p><strong>Costo:</strong> ${formatCurrency(
              recipe.totalCost
            )}</p><p><strong>Venta:</strong> ${formatCurrency(
              recipe.sellPrice
            )}</p>`;
            card.addEventListener("click", () => showRecipeDetails(recipe.id));
            grid.appendChild(card);
            const option = document.createElement("option");
            option.value = recipe.name;
            datalist.appendChild(option);
          });
        };

        const addIngredientRow = (data = {}) => {
          const row = document.createElement("div");
          row.className = "row";
          row.style.gridTemplateColumns = "4fr 3fr 30px";

          const ingredientOptions = Object.entries(ingredientsDB)
            .map(([key, value]) => {
              const selected =
                key === (data.name || "").toLowerCase() ? "selected" : "";
              return `<option value="${key}" ${selected}>${value.name}</option>`;
            })
            .join("");

          const unitOptions = [
            "g",
            "kg",
            "ml",
            "L",
            "oz",
            "lb",
            "cc",
            "taza(s)",
            "cucharada(s)",
            "cucharadita(s)",
            "unidad(es)",
          ];
          const recipeUnitSelect = unitOptions
            .map(
              (u) =>
                `<option value="${u}" ${
                  u === data.recipeUnit ? "selected" : ""
                }>${u}</option>`
            )
            .join("");

          row.innerHTML = `
                <div data-label="Ingrediente">
                  <select class="ingredient-selector"><option value="">Selecciona...</option>${ingredientOptions}</select>
                </div>
                <div class="input-group" data-label="Cantidad en Receta">
                  <input type="number" class="recipe-qty" placeholder="Cantidad" value="${
                    data.recipeQty || ""
                  }">
                  <select class="recipe-unit">${recipeUnitSelect}</select>
                </div>
                <button class="delete-row-btn">&times;</button>
              `;
          ingredientsList.appendChild(row);
        };

        const addLaborRow = (data = {}) => {
          const list = document.getElementById("labor-list");
          const row = document.createElement("div");
          row.className = "row";
          row.style.gridTemplateColumns = "3fr 2fr 2fr 30px";
          const currencySelect = ["$", "€", "Bs."]
            .map(
              (c) =>
                `<option ${c === data.currency ? "selected" : ""}>${c}</option>`
            )
            .join("");
          row.innerHTML = `<div><input type="text" class="labor-task" placeholder="Tarea / Empleado" value="${
            data.task || ""
          }"></div><div class="input-group"><select class="currency">${currencySelect}</select><input type="number" class="labor-rate" placeholder="Salario por Hora" value="${
            data.rate || ""
          }"></div><div><input type="number" class="labor-time" placeholder="Tiempo (minutos)" value="${
            data.time || ""
          }"></div><button class="delete-row-btn">&times;</button>`;
          list.appendChild(row);
        };

        const handleDynamicListClicks = (e) => {
          if (e.target.classList.contains("delete-row-btn")) {
            e.target.closest(".row").remove();
          } else if (e.target.id === "add-ingredient-btn") {
            addIngredientRow();
          } else if (e.target.id === "add-labor-btn") {
            addLaborRow();
          }
        };

        const generateSummary = () => {
          const { ingredientsCost, laborCost, indirectCost, totalCost } =
            calculateAllCosts();
          const profitMargin =
            parseFloat(document.getElementById("profit-margin").value) || 0;
          const sellPrice = totalCost * (1 + profitMargin / 100);
          const summaryContainer = document.getElementById("summary-content");
          summaryContainer.innerHTML = `<div class="summary-item"><span>Costo Total de Materia Prima</span><span>${formatCurrency(
            ingredientsCost
          )}</span></div><div class="summary-item"><span>Costo Total de Mano de Obra</span><span>${formatCurrency(
            laborCost
          )}</span></div><div class="summary-item"><span>Costo Total Indirecto</span><span>${formatCurrency(
            indirectCost
          )}</span></div><div class="summary-item summary-total"><span>Costo Total de Producción</span><span>${formatCurrency(
            totalCost
          )}</span></div>`;
          document.getElementById("suggested-price-summary").textContent =
            formatCurrency(sellPrice);
        };

        const convertUnits = (value, fromUnit, toUnit, ingredientKey) => {
          if (fromUnit === toUnit) return value;
          const ingredientData = ingredientsDB[ingredientKey];
          if (!ingredientData) return value;

          const gramsPerCup = parseFloat(ingredientData.gramsPerCup);
          const gramsPerTbsp = parseFloat(ingredientData.gramsPerTbsp);

          const factors = {
            g: { base: "mass", value: 1 },
            kg: { base: "mass", value: 1000 },
            lb: { base: "mass", value: 453.592 },
            oz: { base: "mass", value: 28.3495 },
            ml: { base: "volume", value: 1 },
            L: { base: "volume", value: 1000 },
            cc: { base: "volume", value: 1 },
            "taza(s)": { base: "volume", value: 236.588, bridge: gramsPerCup },
            "cucharada(s)": {
              base: "volume",
              value: 14.787,
              bridge: gramsPerTbsp,
            },
            "cucharadita(s)": {
              base: "volume",
              value: 4.929,
              bridge: gramsPerTbsp ? gramsPerTbsp / 3 : null,
            },
          };

          const from = factors[fromUnit];
          const to = factors[toUnit];

          if (!from || !to) return value;
          if (from.base === to.base) return (value * from.value) / to.value;

          let valueInGrams;
          if (from.base === "mass") {
            valueInGrams = value * from.value;
          } else {
            if (!from.bridge || isNaN(from.bridge)) {
              alert(
                `Conversión imposible: No has definido los gramos para "${fromUnit}" de "${ingredientData.name}".`
              );
              return value;
            }
            const mlPerUnit = from.value;
            const density = from.bridge / mlPerUnit;
            valueInGrams = value * mlPerUnit * density;
          }

          if (to.base === "mass") {
            return valueInGrams / to.value;
          } else {
            if (!to.bridge || isNaN(to.bridge)) {
              alert(
                `Conversión imposible: No has definido los gramos para "${toUnit}" de "${ingredientData.name}".`
              );
              return value;
            }
            const mlPerUnit = to.value;
            const density = to.bridge / mlPerUnit;
            const valueInMl = valueInGrams / density;
            return valueInMl / to.value;
          }
        };

        const calculateAllCosts = () => {
          let ingredientsCost = 0;
          document.querySelectorAll("#ingredients-list .row").forEach((row) => {
            const ingredientKey = row.querySelector(
              ".ingredient-selector"
            ).value;
            const recipeQty =
              parseFloat(row.querySelector(".recipe-qty").value) || 0;
            const recipeUnit = row.querySelector(".recipe-unit").value;
            const masterData = ingredientsDB[ingredientKey];

            if (masterData && recipeQty > 0) {
              const price = parseFloat(masterData.price) || 0;
              const packageQty = parseFloat(masterData.packageQty) || 1;
              const packageUnit = masterData.packageUnit;
              const convertedRecipeQty = convertUnits(
                recipeQty,
                recipeUnit,
                packageUnit,
                ingredientKey
              );
              if (price > 0 && packageQty > 0) {
                ingredientsCost += (price / packageQty) * convertedRecipeQty;
              }
            }
          });

          let laborCost = 0;
          document.querySelectorAll("#labor-list .row").forEach((row) => {
            const rate =
              parseFloat(row.querySelector(".labor-rate").value) || 0;
            const time =
              parseFloat(row.querySelector(".labor-time").value) || 0;
            if (rate > 0 && time > 0) {
              laborCost += (rate / 60) * time;
            }
          });

          const indirectRate =
            parseFloat(document.getElementById("indirect-cost-rate").value) ||
            0;
          const totalTime =
            parseFloat(
              document.getElementById("total-production-time").value
            ) || 0;
          const indirectCost = (indirectRate / 60) * totalTime;
          const totalCost = ingredientsCost + laborCost + indirectCost;

          return { ingredientsCost, laborCost, indirectCost, totalCost };
        };

        // ===== INICIO FUNCIONES RESTAURADAS Y ADAPTADAS =====
        const loadRecipeForEditing = (recipeId) => {
          const recipe = recipes.find((r) => r.id === recipeId);
          if (!recipe) return;
          resetCalculator();
          editingRecipeId = recipe.id;
          document.getElementById("product-name").value = recipe.name;
          document.getElementById("product-description").value =
            recipe.description;
          document.getElementById("product-image").value = recipe.image;
          if (recipe.yieldInfo) {
            document.getElementById("yield-quantity").value =
              recipe.yieldInfo.quantity;
            document.getElementById("yield-unit").value = recipe.yieldInfo.unit;
          }
          ingredientsList.innerHTML = "";
          recipe.ingredients.forEach((ing) => addIngredientRow(ing));
          document.getElementById("labor-list").innerHTML = "";
          recipe.labor.forEach((lab) => addLaborRow(lab));
          document.getElementById("indirect-cost-rate").value =
            recipe.indirectCostRate;
          document.getElementById("total-production-time").value =
            recipe.totalProductionTime;
          document.getElementById("profit-margin").value = recipe.profitMargin;
          recipeModal.classList.add("hidden");
          showView("calculator");
        };

        const showRecipeDetails = (recipeId) => {
          const recipe = recipes.find((r) => r.id === recipeId);
          if (!recipe) return;

          document.getElementById("modal-title").textContent = recipe.name;
          const body = document.getElementById("modal-body");

          let ingredientsHtml = recipe.ingredients
            .map((ing) => {
              const dbEntry = ingredientsDB[ing.name]; // ing.name is the key
              const displayName = dbEntry ? dbEntry.name : ing.name;
              return `<p>- ${ing.recipeQty} ${ing.recipeUnit} de <strong>${displayName}</strong></p>`;
            })
            .join("");

          body.innerHTML = `
                <img src="${
                  recipe.image ||
                  "https://placehold.co/600x300/FADADD/4E342E?text=Postre"
                }" alt="${
            recipe.name
          }" style="width:100%; border-radius: 8px; margin-bottom: 20px;">
                <p>${recipe.description || "<i>Sin descripción.</i>"}</p>
                <h3 style="margin-top: 15px;">Ingredientes</h3>
                <div style="padding-left: 10px;">${ingredientsHtml}</div>
                <hr style="margin: 20px 0;">
                <p><strong>COSTO TOTAL: ${formatCurrency(
                  recipe.totalCost
                )}</strong></p>
                <p><strong>PRECIO DE VENTA (${
                  recipe.profitMargin
                }%): ${formatCurrency(recipe.sellPrice)}</strong></p>
            `;

          document.getElementById("edit-recipe-btn").onclick = () =>
            loadRecipeForEditing(recipeId);
          document.getElementById("delete-recipe-btn").onclick = () =>
            deleteRecipe(recipeId);
          document.getElementById("share-recipe-btn").onclick = () =>
            shareRecipe(recipeId);

          recipeModal.classList.remove("hidden");
        };
        // ===== FIN FUNCIONES RESTAURADAS Y ADAPTADAS =====

        const formatCurrency = (amount, currency = "$") => {
          return `${currency}${parseFloat(amount || 0).toFixed(2)}`;
        };

        function formatNumber(num) {
          return parseFloat(num.toFixed(4));
        }

        // --- INICIO NUEVAS FUNCIONES PARA GESTIÓN DE BASE DE DATOS DE INGREDIENTES ---

        const renderIngredientsTable = () => {
          const tableBody = document.getElementById(
            "ingredients-db-table-body"
          );
          tableBody.innerHTML = "";

          const sortedKeys = Object.keys(ingredientsDB).sort((a, b) =>
            ingredientsDB[a].name.localeCompare(ingredientsDB[b].name)
          );

          sortedKeys.forEach((key) => {
            const data = ingredientsDB[key];
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td style="padding: 10px;"><strong>${data.name}</strong></td>
              <td style="padding: 10px;">${formatCurrency(
                data.price,
                data.currency
              )} / ${data.packageQty} ${data.packageUnit}</td>
              <td style="padding: 10px;">${data.gramsPerCup || "N/A"}</td>
              <td style="padding: 10px;">${data.gramsPerTbsp || "N/A"}</td>
              <td style="padding: 10px;">
                <button class="edit-ingredient-btn" data-key="${key}" style="border:none; background: #E0F2F1; padding: 5px 8px; border-radius: 5px; cursor: pointer; margin-right: 5px;">✏️</button>
                <button class="delete-ingredient-btn" data-key="${key}" style="border:none; background: #FFCDD2; padding: 5px 8px; border-radius: 5px; cursor: pointer;">🗑️</button>
              </td>
            `;
            tableBody.appendChild(tr);
          });
        };

        const saveIngredientsToDB = async () => {
          if (!currentUser) return;
          try {
            await setDoc(
              doc(db, "users", currentUser.uid, "data", "ingredients_master"),
              ingredientsDB
            );
          } catch (error) {
            console.error("Error guardando ingredientes:", error);
          }
        };

        const handleSaveIngredient = async (e) => {
          e.preventDefault();
          const name = document.getElementById("db-ingredient-name").value;
          const key = editingIngredientKey || name.trim().toLowerCase();

          if (!key) return alert("El nombre del ingrediente es obligatorio.");

          ingredientsDB[key] = {
            name: name,
            currency: document.getElementById("db-ingredient-currency").value,
            price:
              parseFloat(
                document.getElementById("db-ingredient-price").value
              ) || 0,
            packageQty:
              parseFloat(document.getElementById("db-ingredient-qty").value) ||
              0,
            packageUnit: document.getElementById("db-ingredient-unit").value,
            gramsPerCup:
              parseFloat(document.getElementById("db-ingredient-cup").value) ||
              null,
            gramsPerTbsp:
              parseFloat(document.getElementById("db-ingredient-tbsp").value) ||
              null,
          };

          await saveIngredientsToDB();
          renderIngredientsTable();
          hideIngredientForm();
          editingIngredientKey = null; // Resetear
        };

        const handleTableClicks = (e) => {
          const target = e.target.closest("button");
          if (!target) return;

          const key = target.dataset.key;
          if (target.classList.contains("edit-ingredient-btn")) {
            editingIngredientKey = key;
            const data = ingredientsDB[key];
            document.getElementById(
              "ingredient-form-title"
            ).textContent = `Editando: ${data.name}`;
            document.getElementById("db-ingredient-name").value = data.name;
            document.getElementById("db-ingredient-currency").value =
              data.currency;
            document.getElementById("db-ingredient-price").value = data.price;
            document.getElementById("db-ingredient-qty").value =
              data.packageQty;
            document.getElementById("db-ingredient-unit").value =
              data.packageUnit;
            document.getElementById("db-ingredient-cup").value =
              data.gramsPerCup;
            document.getElementById("db-ingredient-tbsp").value =
              data.gramsPerTbsp;
            document.getElementById("db-ingredient-name").readOnly = true;
            showIngredientForm();
          } else if (target.classList.contains("delete-ingredient-btn")) {
            if (
              confirm(
                `¿Seguro que quieres eliminar "${ingredientsDB[key].name}" de tu base de datos?`
              )
            ) {
              delete ingredientsDB[key];
              saveIngredientsToDB();
              renderIngredientsTable();
            }
          }
        };

        const showIngredientForm = () => {
          document
            .getElementById("ingredient-db-form")
            .classList.remove("hidden");
          document
            .getElementById("show-ingredient-form-btn")
            .classList.add("hidden");
        };

        const hideIngredientForm = () => {
          document.getElementById("ingredient-db-form").classList.add("hidden");
          document
            .getElementById("show-ingredient-form-btn")
            .classList.remove("hidden");
          document.getElementById("ingredient-db-form").reset();
          document.getElementById("ingredient-form-title").textContent =
            "Añadir Nuevo Ingrediente";
          document.getElementById("db-ingredient-name").readOnly = false;
          editingIngredientKey = null;
        };

        const unitOptionsHtml = [
          "g",
          "kg",
          "ml",
          "L",
          "oz",
          "lb",
          "cc",
          "unidad(es)",
        ]
          .map((u) => `<option value="${u}">${u}</option>`)
          .join("");
        document.getElementById("db-ingredient-unit").innerHTML =
          unitOptionsHtml;
        const currencyOptionsHtml = ["$", "€", "Bs."]
          .map((c) => `<option value="${c}">${c}</option>`)
          .join("");
        document.getElementById("db-ingredient-currency").innerHTML =
          currencyOptionsHtml;

        // Conexión de Event Listeners
        newCostBtn.addEventListener("click", () => {
          resetCalculator();
          showView("calculator");
        });
        nextBtn.addEventListener("click", () => {
          if (currentStep < totalSteps) {
            currentStep++;
            updateWizard();
          }
        });
        prevBtn.addEventListener("click", () => {
          if (currentStep > 1) {
            currentStep--;
            updateWizard();
          }
        });
        saveBtn.addEventListener("click", saveRecipe);
        calculatorView.addEventListener("click", handleDynamicListClicks);
        document.querySelectorAll(".close-modal-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            e.target.closest(".modal-wrapper").classList.add("hidden");
          });
        });
        calculatorView.addEventListener("input", () => {
          if (currentStep === totalSteps) generateSummary();
        });
        document
          .getElementById("import-from-code-btn")
          .addEventListener("click", importRecipeByCode);

        document
          .getElementById("manage-ingredients-btn")
          .addEventListener("click", () =>
            ingredientsDbModal.classList.remove("hidden")
          );
        document
          .getElementById("ingredient-db-form")
          .addEventListener("submit", handleSaveIngredient);
        document
          .getElementById("ingredients-db-table-body")
          .addEventListener("click", handleTableClicks);
        document
          .getElementById("show-ingredient-form-btn")
          .addEventListener("click", showIngredientForm);
        document
          .getElementById("cancel-edit-ingredient-btn")
          .addEventListener("click", hideIngredientForm);

        [recipeModal, ingredientsDbModal].forEach((modal) => {
          modal.addEventListener("click", (e) => {
            if (e.target === modal) modal.classList.add("hidden");
          });
        });
      });
    </script>
  </body>
</html>
