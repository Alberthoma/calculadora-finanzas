<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Gestor de Presupuesto Web</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Librerías para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
<!-- Firebase SDKs -->
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales para Firebase (serán accesibles en el script principal)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        // Se asignan directamente las funciones importadas a window
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.getFirestore = getFirestore; 
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.writeBatch = writeBatch;

        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCTicX5tqqVr3pK_RFqgvqpRavsUuTvS2g",
            authDomain: "wittfinances-282f1.firebaseapp.com",
            projectId: "wittfinances-282f1",
            storageBucket: "wittfinances-282f1.firebasestorage.app",
            messagingSenderId: "998192322959",
            appId: "1:998192322959:web:e2afcdd7f47da3767853fa"
        };
        
        console.log("[Firebase Init] Configuración de Firebase recibida:", firebaseConfig); // Debugging

        if (firebaseConfig && firebaseConfig.projectId) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);
            // Hacemos el projectId accesible globalmente para construir las rutas de Firestore
            window.firebaseProjectId = firebaseConfig.projectId; 
            console.log("[Firebase Init] Firebase inicializado con éxito."); // Debugging
        } else {
            console.error("[Firebase Init] ERROR: 'projectId' no proporcionado en la configuración de Firebase.");
            console.error("Asegúrate de que estás ejecutando la aplicación en un entorno que inyecta __firebase_config (como Canvas o Firebase Hosting).");
            // Mostrar un mensaje de error al usuario si la inicialización falla
            document.addEventListener('DOMContentLoaded', () => {
                const loadingOverlay = document.getElementById('loading-overlay');
                const messageModal = document.getElementById('message-modal');
                const messageModalTitle = document.getElementById('message-modal-title');
                const messageModalContent = document.getElementById('message-modal-content');
                const messageModalCloseBtn = document.getElementById('message-modal-close-btn');

                loadingOverlay.classList.remove('active'); // Ocultar spinner
                messageModalTitle.textContent = "Error de Configuración de Firebase";
                messageModalContent.textContent = "La aplicación no pudo conectarse a Firebase. Asegúrate de que el proyecto esté configurado correctamente y que la aplicación se ejecute en un servidor (Firebase Hosting o localmente con 'firebase serve').";
                messageModal.classList.add('active');
                messageModalCloseBtn.addEventListener('click', () => messageModal.classList.remove('active'));
            });
        }
    </script>
<style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .table-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            background-color: #f9fafb;
            text-align: right;
        }
        .table-input:focus {
            outline: 2px solid #3b82f6;
            border-color: transparent;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-overlay.active {
            display: flex;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilos para ocultar el contenido principal cuando el modal de autenticación está activo */
        body.auth-modal-active #main-content-wrapper {
            display: none;
        }

        /* Estilos para el spinner de botón */
        .btn-spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        .btn-spinner.hidden {
            display: none;
        }

        /* Estilos para notificaciones Toast */
        #toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column-reverse; /* Para que los nuevos toasts aparezcan arriba */
            gap: 0.5rem;
        }
        .toast {
            background-color: #333;
            color: #fff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(100%);
            min-width: 200px;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        .toast-icon {
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }
        .toast-icon svg {
            fill: currentColor; /* Para que el color del SVG sea el del texto del toast */
        }

        /* Estilos para mensajes de error de validación */
        .input-error-message {
            color: #dc3545;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }
        .input-error-message.active {
            display: block;
        }
    </style>
<style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
    </style></head>
<body class="bg-gray-100 text-gray-800">
<!-- Overlay de Carga Global -->
<div class="loading-overlay active" id="loading-overlay">
<div class="spinner"></div>
<p class="ml-4 text-lg text-gray-700">Cargando datos...</p>
</div>
<!-- Contenedor de Notificaciones Toast -->
<div id="toast-container"></div>
<!-- Modal de Autenticación -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="auth-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col">
<h2 class="text-2xl font-bold p-6 border-b flex-shrink-0 text-center">Bienvenido al Gestor de Presupuesto</h2>
<div class="p-6 flex-grow">
<div class="mb-4 text-center">
<p class="text-gray-600">Inicia sesión o regístrate para acceder a tus datos.</p>
</div>
<form class="space-y-4" id="auth-form">
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="auth-email">Correo Electrónico</label>
<input class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="auth-email" required="" type="email"/>
<span class="input-error-message" id="auth-email-error"></span>
</div>
<div>
<label class="block text-sm font-medium text-gray-700 mb-1" for="auth-password">Contraseña</label>
<input class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="auth-password" required="" type="password"/>
<span class="input-error-message" id="auth-password-error"></span>
</div>
<div class="flex flex-col sm:flex-row justify-between gap-3 pt-4">
<button class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center" id="login-btn" type="submit">
                            Iniciar Sesión <span class="btn-spinner hidden"></span>
</button>
<button class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center justify-center" id="register-btn" type="button">
                            Registrarse <span class="btn-spinner hidden"></span>
</button>
</div>
</form>
</div>
</div>
</div>
<!-- Contenido Principal de la Aplicación -->
<div class="container mx-auto p-4 md:p-8" id="main-content-wrapper">
<!-- Cabecera -->
<header class="mb-8 flex justify-between items-center">
<div>
<h1 class="text-4xl font-bold text-gray-900">Gestor de Presupuesto Web</h1>
<p class="text-gray-600 mt-1">Tu panel de control financiero, moderno y eficiente.</p>
<!-- Mostrar el alias del usuario o el ID si no hay alias -->
<div class="text-sm text-gray-500 mt-2">Bienvenido, <span class="font-semibold text-gray-700" id="user-alias-display">Cargando...</span></div>
<div class="mt-2 text-sm text-yellow-700" id="credit-card-alerts"></div>
</div>
<button class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center justify-center" id="logout-btn">
                Cerrar Sesión <span class="btn-spinner hidden"></span>
</button>
</header>
<!-- Panel de Control (Dashboard) -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="dashboard">
<div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
<div>
<p class="text-sm text-gray-500">Saldo Actual</p>
<p class="text-3xl font-bold text-blue-600" id="current-balance">$0.00</p>
</div>
<div class="bg-blue-100 p-3 rounded-full">
<svg class="text-blue-600" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="12" x2="12" y1="1" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
</div>
</div>
<div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
<div>
<p class="text-sm text-gray-500">Ingresos del Mes</p>
<p class="text-3xl font-bold text-green-600" id="monthly-income">$0.00</p>
</div>
<div class="bg-green-100 p-3 rounded-full">
<svg class="text-green-600" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="12" x2="12" y1="19" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
</div>
</div>
<div class="bg-white p-6 rounded-xl shadow-md flex items-center justify-between">
<div>
<p class="text-sm text-gray-500">Gastos del Mes</p>
<p class="text-3xl font-bold text-red-600" id="monthly-expenses">$0.00</p>
</div>
<div class="bg-red-100 p-3 rounded-full">
<svg class="text-red-600" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><line x1="12" x2="12" y1="5" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
</div>
</div>
</div>
<!-- Panel principal con Pestañas -->
<main class="bg-white p-6 rounded-xl shadow-md">
<div class="flex flex-col md:flex-row md:items-center md:justify-between border-b border-gray-200 mb-6">
<!-- Pestañas de Navegación -->
<div class="flex space-x-1 md:space-x-4 mb-4 md:mb-0 overflow-x-auto pb-2" id="tabs">
<button class="tab-button whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition" data-tab="calculadora">Calculadora</button>
<button class="tab-button whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition active" data-tab="registros">Registros</button>
<button class="tab-button whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition" data-tab="recurrentes">Gastos Recurrentes</button>
<button class="tab-button whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition" data-tab="tarjetas">Tarjetas de Crédito</button>
<button class="tab-button whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition" data-tab="reportes">Reportes</button>
<button class="tab-button whitespace-nowrap px-4 py-2 text-sm font-medium border-b-2 border-transparent hover:text-blue-600 hover:border-blue-600 transition" data-tab="configuracion">Configuración</button>
</div>
<!-- Botón de Acción Principal -->
<button class="w-full md:w-auto bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center justify-center space-x-2" id="main-action-btn">
<svg fill="none" height="20" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>
<span id="main-action-btn-text">Registrar Transacción</span>
</button>
</div>
<!-- Contenido de las Pestañas -->
<div id="tab-content">
<!-- Pestaña de Registros -->
<div class="tab-pane active" id="registros-content">
<div class="flex flex-col md:flex-row gap-4 mb-4">
<input class="flex-grow p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="filter-description" placeholder="Filtrar por descripción..." type="text"/>
<select class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="filter-category" type="text">
<option value="">Todas las categorías</option>
</select>
<input class="p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" id="filter-month" type="month"/>
</div>
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ingreso</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Gasto</th>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200" id="transactions-table-body"></tbody>
</table>
<p class="text-center text-gray-500 py-8" id="no-transactions-message">No hay transacciones para el período seleccionado.</p>
</div>
</div>
<!-- Pestaña de Gastos Recurrentes -->
<div class="tab-pane hidden" id="recurrentes-content">
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
<th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Banco/Cuenta</th>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Día de Pago</th>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200" id="recurring-expenses-table-body"></tbody>
<tfoot class="bg-gray-50">
<tr>
<td class="px-6 py-4 text-right font-bold text-gray-700 text-sm uppercase" colspan="5">Total Mensual Proyectado</td>
<td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold text-red-700" id="recurring-total">$0.00</td>
</tr>
</tfoot>
</table>
<p class="text-center text-gray-500 py-8" id="no-recurring-expenses-message">No has añadido ningún gasto recurrente.</p>
</div>
</div>
<!-- Pestaña de Tarjetas de Crédito -->
<div class="tab-pane hidden" id="tarjetas-content">
<div class="overflow-x-auto">
<table class="min-w-full divide-y divide-gray-200">
<thead class="bg-gray-50">
<tr>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Banco</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Pago</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto Adeudado</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tasa Interés (Anual %)</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Meses para Saldar</th>
<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pago Mensual Sugerido</th>
<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
</tr>
</thead>
<tbody class="bg-white divide-y divide-gray-200" id="credit-cards-table-body"></tbody>
</table>
<p class="text-center text-gray-500 py-8" id="no-credit-cards-message">No has añadido ninguna tarjeta de crédito.</p>
</div>
</div>
<!-- Pestaña de Reportes -->
<div class="tab-pane hidden" id="reportes-content">
<div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
<div>
<h3 class="text-lg font-semibold mb-4">Gastos por Categoría (Gráfico)</h3>
<div class="w-full h-80 md:h-96 relative">
<canvas id="expenses-chart"></canvas>
</div>
</div>
<div>
<h3 class="text-lg font-semibold mb-4">Gastos por Categoría (Totales)</h3>
<div class="space-y-3 max-h-96 overflow-y-auto pr-2" id="category-totals-list"></div>
<div class="border-t mt-4 pt-4">
<div class="flex justify-between items-center font-bold text-lg">
<span>Total de Gastos:</span>
<span class="text-red-600" id="total-expenses-report">$0.00</span>
</div>
</div>
</div>
</div>
<div class="mt-8">
<h3 class="text-lg font-semibold mb-4">Flujo de Efectivo Mensual</h3>
<div class="w-full h-80 md:h-96 relative">
<canvas id="cash-flow-chart"></canvas>
</div>
</div>
</div>
<!-- Pestaña de Configuración -->
<div class="tab-pane hidden" id="configuracion-content">
<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
<div>
<h3 class="text-lg font-semibold mb-4">Gestionar Categorías</h3>
<div class="mb-4">
<input class="w-full p-2 border rounded-lg mb-2" id="new-category-name" placeholder="Nombre de nueva categoría" type="text"/>
<span class="input-error-message" id="new-category-name-error"></span>
<button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="add-category-btn">
                                    Añadir Categoría <span class="btn-spinner hidden"></span>
</button>
</div>
<div class="max-h-60 overflow-y-auto border rounded-lg p-2">
<ul class="space-y-2" id="category-list"></ul>
</div>
</div>
<div>
<h3 class="text-lg font-semibold mb-4">Gestionar Bancos/Cuentas</h3>
<div class="mb-4">
<input class="w-full p-2 border rounded-lg mb-2" id="new-bank-name" placeholder="Nombre de nuevo banco" type="text"/>
<span class="input-error-message" id="new-bank-name-error"></span>
<button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="add-bank-btn">
                                    Añadir Banco <span class="btn-spinner hidden"></span>
</button>
</div>
<div class="max-h-60 overflow-y-auto border rounded-lg p-2">
<ul class="space-y-2" id="bank-list"></ul>
</div>
</div>
<div>
<h3 class="text-lg font-semibold mb-4">Gestionar Descripciones</h3>
<div class="max-h-72 overflow-y-auto border rounded-lg p-2">
<ul class="space-y-2" id="description-list-config"></ul>
</div>
</div>
</div>
<div class="mt-8 border-t pt-6">
<h3 class="text-lg font-semibold mb-4">Configuración de Usuario</h3>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="user-alias">Tu Alias/Nombre Visible</label>
<input class="w-full p-2 border rounded-lg mb-2" id="user-alias" placeholder="Ej: Mi Presupuesto Feliz" type="text"/>
<span class="input-error-message" id="user-alias-error"></span>
<button class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex items-center justify-center" id="save-alias-btn">
                                Guardar Alias <span class="btn-spinner hidden"></span>
</button>
</div>
</div>
<div class="mt-8 border-t pt-6">
<h3 class="text-lg font-semibold mb-4">Acciones de Período</h3>
<button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center justify-center" id="initiate-new-month-btn">
                            Iniciar Nuevo Mes <span class="btn-spinner hidden"></span>
</button>
<p class="text-sm text-gray-500 mt-2">Crea un archivo de respaldo y prepara la aplicación para el siguiente mes.</p>
</div>
<div class="mt-8 border-t pt-6">
<h3 class="text-lg font-semibold mb-4">Importar y Exportar</h3>
<div class="flex flex-wrap gap-4">
<button class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800" id="export-pdf-btn">Exportar a PDF</button>
<button class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800" id="export-json-btn">Exportar Datos (JSON)</button>
<button class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center justify-center" id="import-json-btn" type="button">
                                Importar Datos (JSON) <span class="btn-spinner hidden"></span>
</button>
<input accept=".json" class="hidden" id="import-file-input" type="file"/>
</div>
<p class="text-sm text-gray-500 mt-2">Guarda o carga los datos de un período específico.</p>
</div>
<div class="mt-8 border-t pt-6">
<h3 class="text-lg font-semibold mb-4 text-red-600">Zona de Peligro</h3>
<button class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center justify-center" id="reset-data-btn">
                            Reiniciar Todos los Datos <span class="btn-spinner hidden"></span>
</button>
<p class="text-sm text-gray-500 mt-2">¡Cuidado! Esta acción eliminará permanentemente todos los datos actuales.</p>
</div>
</div>
<!-- Pestaña de Calculadora -->
<div class="tab-pane hidden p-0 m-0" id="calculadora-content">
<div class="w-full max-w-4xl mx-auto">
<div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
<div class="text-center mb-8">
<h1 class="text-3xl md:text-4xl font-bold text-blue-600">Calculadora de Salario Neto Avanzada</h1>
<p class="text-gray-500 mt-2">Estima tu pago en Florida con Overtime y Préstamos (Año Fiscal 2025)</p>
</div>
<!-- Inputs Section -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
<!-- Earnings Information -->
<div class="bg-gray-50 p-6 rounded-xl">
<h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Información de Ingresos</h2>
<div class="space-y-4">
<div>
<label class="block text-sm font-medium text-gray-600" for="hourlyRate">Tarifa por Hora ($)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="hourlyRate" type="number" value="25"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-600" for="hoursWorked">Horas Totales Trabajadas (Quincenal)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="hoursWorked" type="number" value="80"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-600" for="filingStatus">Estado Civil Tributario</label>
<select class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="filingStatus">
<option value="single">Soltero/a</option>
<option value="married">Casado/a (declaración conjunta)</option>
</select>
</div>
</div>
</div>
<!-- Deductions -->
<div class="bg-gray-50 p-6 rounded-xl">
<h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Deducciones Voluntarias</h2>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium text-gray-600" for="contribution401kType">Tipo 401(k)</label>
<select class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="contribution401kType">
<option value="percent">% del Salario</option>
<option value="amount">Monto Fijo ($)</option>
</select>
</div>
<div>
<label class="block text-sm font-medium text-gray-600" for="contribution401kValue" id="contribution401kLabel">Valor 401(k)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="contribution401kValue" type="number" value="5"/>
</div>
</div>
<div class="space-y-4 mt-4">
<div>
<label class="block text-sm font-medium text-gray-600" for="medicalDeduction">Seguro Médico ($ por período)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="medicalDeduction" type="number" value="150"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-600" for="dentalDeduction">Seguro Dental ($ por período)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="dentalDeduction" type="number" value="20"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-600" for="visionDeduction">Seguro de Visión ($ por período)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="visionDeduction" type="number" value="10"/>
</div>
<div>
<label class="block text-sm font-medium text-gray-600" for="loan401k">Préstamo de 401(k) ($ por período)</label>
<input class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" id="loan401k" type="number" value="0"/>
</div>
</div>
</div>
</div>
<!-- Calculate Button -->
<div class="text-center mb-8">
<button class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-colors duration-300 text-lg shadow-md" id="calculateBtn">
                    Calcular Salario Neto
                </button>
</div>
<!-- Results Section -->
<div class="bg-blue-50 p-6 rounded-xl hidden" id="results">
<h2 class="text-2xl font-bold text-center mb-6 text-blue-800">Resumen del Pago</h2>
<div class="result-grid">
<div class="text-center p-4 bg-white rounded-lg shadow">
<p class="text-sm text-gray-500">Salario Bruto</p>
<p class="text-xl font-semibold text-green-600" id="grossPayResult">$0.00</p>
</div>
<div class="text-center p-4 bg-white rounded-lg shadow">
<p class="text-sm text-gray-500">Deduc. Pre-Impuestos</p>
<p class="text-xl font-semibold text-orange-500" id="preTaxDeductionsResult">$0.00</p>
</div>
<div class="text-center p-4 bg-white rounded-lg shadow">
<p class="text-sm text-gray-500">Impuesto Federal</p>
<p class="text-xl font-semibold text-red-500" id="federalTaxResult">$0.00</p>
</div>
<div class="text-center p-4 bg-white rounded-lg shadow">
<p class="text-sm text-gray-500">Impuestos FICA</p>
<p class="text-xl font-semibold text-red-500" id="ficaTaxResult">$0.00</p>
</div>
<div class="text-center p-4 bg-white rounded-lg shadow">
<p class="text-sm text-gray-500">Deduc. Post-Impuestos</p>
<p class="text-xl font-semibold text-red-500" id="postTaxDeductionsResult">$0.00</p>
</div>
</div>
<div class="mt-6 pt-6 border-t-2 border-dashed border-blue-200 text-center">
<p class="text-lg text-gray-700">Tu Salario Neto Estimado es:</p>
<p class="text-4xl md:text-5xl font-extrabold text-blue-700 mt-2" id="netPayResult">$0.00</p>
<p class="text-xs text-gray-500 mt-4">por período de pago quincenal</p>
</div>
</div>
<div class="text-xs text-gray-400 text-center mt-6">
<p><strong>Descargo de responsabilidad:</strong> Esta es una herramienta de estimación. Las cifras reales pueden variar. El cálculo del impuesto federal es una aproximación. El límite anual del Seguro Social no se tiene en cuenta en este cálculo por período.</p>
</div>
</div>
</div>

</div>
</div>
</main>
</div>
<!-- Modales -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="transaction-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
<h2 class="text-2xl font-bold p-6 border-b flex-shrink-0" id="modal-title">Registrar Transacción</h2>
<form class="flex flex-col flex-grow overflow-hidden" id="transaction-form">
<div class="p-6 flex-grow overflow-y-auto">
<input id="transaction-id" type="hidden"/>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transaction-date">Fecha</label>
<input class="w-full p-2 border rounded-lg" id="transaction-date" required="" type="date"/>
<span class="input-error-message" id="transaction-date-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transaction-description">Descripción</label>
<input class="w-full p-2 border rounded-lg" id="transaction-description" list="description-list" required="" type="text"/>
<datalist id="description-list"></datalist>
<span class="input-error-message" id="transaction-description-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transaction-category">Categoría</label>
<select class="w-full p-2 border rounded-lg" id="transaction-category" required="" type="text"></select>
<span class="input-error-message" id="transaction-category-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transaction-bank">Banco/Cuenta</label>
<select class="w-full p-2 border rounded-lg" id="transaction-bank" required="" type="text"></select>
<span class="input-error-message" id="transaction-bank-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transaction-amount">Monto</label>
<input class="w-full p-2 border rounded-lg" id="transaction-amount" required="" step="0.01" type="number"/>
<span class="input-error-message" id="transaction-amount-error"></span>
</div>
<div class="mb-2">
<label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Transacción</label>
<div class="flex gap-4">
<label class="flex items-center">
<input checked="" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="transaction-type" type="radio" value="income"/>
<span class="ml-2 text-gray-700">Ingreso</span>
</label>
<label class="flex items-center">
<input class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" name="transaction-type" type="radio" value="expense"/>
<span class="ml-2 text-gray-700">Gasto</span>
</label>
</div>
<span class="input-error-message" id="transaction-type-error"></span>
</div>
</div>
<div class="p-6 border-t flex-shrink-0 flex justify-between items-center gap-4">
<button class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm" id="open-transfer-modal-btn" type="button">Registrar Transferencia Interna</button>
<div class="flex justify-end gap-4">
<button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" id="cancel-btn" type="button">Cancelar</button>
<button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="save-transaction-btn" type="submit">
                            Guardar <span class="btn-spinner hidden"></span>
</button>
</div>
</div>
</form>
</div>
</div>
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="transfer-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
<h2 class="text-2xl font-bold p-6 border-b flex-shrink-0">Registrar Transferencia Interna</h2>
<form class="flex flex-col flex-grow overflow-hidden" id="transfer-form">
<div class="p-6 flex-grow overflow-y-auto">
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-date">Fecha</label>
<input class="w-full p-2 border rounded-lg" id="transfer-date" required="" type="date"/>
<span class="input-error-message" id="transfer-date-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-from-bank">Desde la cuenta</label>
<select class="w-full p-2 border rounded-lg" id="transfer-from-bank" required="" type="text"></select>
<span class="input-error-message" id="transfer-from-bank-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-to-bank">Hacia la cuenta</label>
<select class="w-full p-2 border rounded-lg" id="transfer-to-bank" required="" type="text"></select>
<span class="input-error-message" id="transfer-to-bank-error"></span>
</div>
<div class="mb-2">
<label class="block text-sm font-medium text-gray-700 mb-1" for="transfer-amount">Monto a Transferir</label>
<input class="w-full p-2 border rounded-lg" id="transfer-amount" required="" step="0.01" type="number"/>
<span class="input-error-message" id="transfer-amount-error"></span>
</div>
</div>
<div class="p-6 border-t flex-shrink-0 flex justify-end gap-4">
<button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" id="transfer-cancel-btn" type="button">Cancelar</button>
<button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="confirm-transfer-btn" type="submit">
                        Confirmar Transferencia <span class="btn-spinner hidden"></span>
</button>
</div>
</form>
</div>
</div>
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="recurring-expense-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
<h2 class="text-2xl font-bold p-6 border-b flex-shrink-0" id="recurring-modal-title">Añadir Gasto Recurrente</h2>
<form class="flex flex-col flex-grow overflow-hidden" id="recurring-expense-form">
<div class="p-6 flex-grow overflow-y-auto">
<input id="recurring-expense-id" type="hidden"/>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="recurring-description">Descripción</label>
<input class="w-full p-2 border rounded-lg" id="recurring-description" list="description-list" required="" type="text"/>
<span class="input-error-message" id="recurring-description-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="recurring-amount">Monto</label>
<input class="w-full p-2 border rounded-lg" id="recurring-amount" required="" step="0.01" type="number"/>
<span class="input-error-message" id="recurring-amount-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="recurring-category">Categoría</label>
<select class="w-full p-2 border rounded-lg" id="recurring-category" required="" type="text"></select>
<span class="input-error-message" id="recurring-category-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="recurring-bank">Banco/Cuenta</label>
<select class="w-full p-2 border rounded-lg" id="recurring-bank" required="" type="text"></select>
<span class="input-error-message" id="recurring-bank-error"></span>
</div>
<div class="mb-2">
<label class="block text-sm font-medium text-gray-700 mb-1" for="recurring-day">Día de Pago (1-31)</label>
<input class="w-full p-2 border rounded-lg" id="recurring-day" max="31" min="1" required="" type="number"/>
<span class="input-error-message" id="recurring-day-error"></span>
</div>
</div>
<div class="p-6 border-t flex-shrink-0 flex justify-end gap-4">
<button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" id="recurring-cancel-btn" type="button">Cancelar</button>
<button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="save-recurring-btn" type="submit">
                        Guardar <span class="btn-spinner hidden"></span>
</button>
</div>
</form>
</div>
</div>
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="credit-card-modal">
<div class="bg-white rounded-lg shadow-xl w-full max-w-md flex flex-col" style="max-height: 90vh;">
<h2 class="text-2xl font-bold p-6 border-b flex-shrink-0">Añadir Tarjeta</h2>
<form class="flex flex-col flex-grow overflow-hidden" id="credit-card-form">
<div class="p-6 flex-grow overflow-y-auto">
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-bank">Banco</label>
<input class="w-full p-2 border rounded-lg" id="credit-card-bank" placeholder="Ej: Banco Mercantil" required="" type="text"/>
<span class="input-error-message" id="credit-card-bank-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-due-date">Día de Pago (1-31)</label>
<input class="w-full p-2 border rounded-lg" id="credit-card-due-date" max="31" min="1" required="" type="number"/>
<span class="input-error-message" id="credit-card-due-date-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-amount">Monto Adeudado</label>
<input class="w-full p-2 border rounded-lg" id="credit-card-amount" required="" step="0.01" type="number"/>
<span class="input-error-message" id="credit-card-amount-error"></span>
</div>
<div class="mb-4">
<label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-rate">Tasa de Interés (Anual %)</label>
<input class="w-full p-2 border rounded-lg" id="credit-card-rate" required="" step="0.01" type="number"/>
<span class="input-error-message" id="credit-card-rate-error"></span>
</div>
<div class="mb-2">
<label class="block text-sm font-medium text-gray-700 mb-1" for="credit-card-months">Meses para Saldar</label>
<input class="w-full p-2 border rounded-lg" id="credit-card-months" min="1" required="" type="number"/>
<span class="input-error-message" id="credit-card-months-error"></span>
</div>
</div>
<div class="p-6 border-t flex-shrink-0 flex justify-end gap-4">
<button class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300" id="credit-card-cancel-btn" type="button">Cancelar</button>
<button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center" id="save-credit-card-btn" type="submit">
                        Añadir Tarjeta <span class="btn-spinner hidden"></span>
</button>
</div>
</form>
</div>
</div>
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="confirm-modal">
<div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4"><svg aria-hidden="true" class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" stroke-linecap="round" stroke-linejoin="round"></path></svg></div>
<h2 class="text-2xl font-bold mb-4" id="confirm-modal-title">Confirmar Acción</h2>
<p class="text-gray-600 mb-6" id="confirm-modal-message">¿Estás seguro? Esta acción no se puede deshacer.</p>
<div class="flex justify-center gap-4"><button class="bg-gray-200 text-gray-800 px-6 py-2 rounded-lg hover:bg-gray-300" id="confirm-modal-cancel-btn" type="button">Cancelar</button><button class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700" id="confirm-modal-confirm-btn" type="button">Confirmar</button></div>
</div>
</div>
<!-- Nuevo Modal para Mensajes -->
<div class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4" id="message-modal">
<div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-center">
<h2 class="text-2xl font-bold mb-4" id="message-modal-title">Mensaje</h2>
<p class="text-gray-600 mb-6" id="message-modal-content"></p>
<button class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700" id="message-modal-close-btn" type="button">Cerrar</button>
</div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const { jsPDF } = window.jspdf;

        // --- REFERENCIAS DE FIREBASE (ACCESIBLES GLOBALMENTE) ---
        // Estas variables serán null si Firebase no se inicializó correctamente en el script type="module"
        const app = window.firebaseApp;
        const db = window.db;
        const auth = window.auth;
        const onAuthStateChanged = window.onAuthStateChanged;
        const signInAnonymously = window.signInAnonymously;
        const signInWithCustomToken = window.signInWithCustomToken;
        // Las funciones de autenticación se accederán directamente a través de window en las funciones handleRegister, handleLogin, handleLogout
        const doc = window.doc;
        const getDoc = window.getDoc;
        const setDoc = window.setDoc;
        const updateDoc = window.updateDoc;
        const deleteDoc = window.deleteDoc;
        const onSnapshot = window.onSnapshot;
        const collection = window.collection;
        const query = window.query;
        const getDocs = window.getDocs;
        const writeBatch = window.writeBatch;

        // Si Firebase no se inicializó, salimos temprano del script principal
        if (!app || !db || !auth) {
            console.error("[App Init] Firebase no inicializado. La aplicación no puede funcionar.");
            return; 
        }

        // Obtenemos el Project ID de Firebase que se hizo global en el script type="module"
        const firebaseProjectId = window.firebaseProjectId;
        if (!firebaseProjectId) {
            console.error("[App Init] Firebase Project ID no disponible. No se pueden construir las rutas de Firestore.");
            showMessageModal("Error de Configuración", "El ID del proyecto Firebase no está disponible. Recarga la página o verifica tu configuración.", "error");
            hideLoading();
            return;
        }


        // --- ESTADO DE LA APLICACIÓN ---
        let appState = {
            transactions: [],
            categories: [],
            banks: [],
            descriptions: [],
            recurringExpenses: [],
            creditCards: [],
            openingBalance: 0,
            userAlias: null, // Nuevo campo para el alias del usuario
            // Futura mejora: Añadir estructura para presupuestos por categoría
            // categoryBudgets: {}, 
        };
        let userId = null;
        let isAuthReady = false; // Bandera para saber si la autenticación ha terminado
        let currentMonthFilterValue = ''; // Para mantener el filtro de mes al recargar datos

        // --- ELEMENTOS DEL DOM ---
        const mainContentWrapper = document.getElementById('main-content-wrapper');
        const authModal = document.getElementById('auth-modal');
        const authForm = document.getElementById('auth-form');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');

        const mainActionBtn = document.getElementById('main-action-btn');
        const mainActionBtnText = document.getElementById('main-action-btn-text');
        const transactionModal = document.getElementById('transaction-modal');
        const transactionForm = document.getElementById('transaction-form');
        const cancelBtn = document.getElementById('cancel-btn');
        const transactionsTableBody = document.getElementById('transactions-table-body');
        const noTransactionsMessage = document.getElementById('no-transactions-message');
        const filterMonth = document.getElementById('filter-month');
        const filterDescription = document.getElementById('filter-description');
        const filterCategory = document.getElementById('filter-category');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalConfirmBtn = document.getElementById('confirm-modal-confirm-btn');
        const confirmModalCancelBtn = document.getElementById('confirm-modal-cancel-btn');
        const importFileInput = document.getElementById('import-file-input');
        const creditCardsTableBody = document.getElementById('credit-cards-table-body');
        const noCreditCardsMessage = document.getElementById('no-credit-cards-message');
        const creditCardModal = document.getElementById('credit-card-modal');
        const creditCardForm = document.getElementById('credit-card-form');
        const openTransferModalBtn = document.getElementById('open-transfer-modal-btn');
        const transferModal = document.getElementById('transfer-modal');
        const transferForm = document.getElementById('transfer-form');
        const transferCancelBtn = document.getElementById('transfer-cancel-btn');
        const recurringExpenseModal = document.getElementById('recurring-expense-modal');
        const recurringExpenseForm = document.getElementById('recurring-expense-form');
        const recurringCancelBtn = document.getElementById('recurring-cancel-btn');
        const recurringExpensesTableBody = document.getElementById('recurring-expenses-table-body');
        const noRecurringExpensesMessage = document.getElementById('no-recurring-expenses-message');
        // const userIdDisplay = document.getElementById('user-id-display'); // Eliminado, ahora usamos user-alias-display
        const userAliasDisplay = document.getElementById('user-alias-display'); // Nuevo elemento para mostrar el alias
        const loadingOverlay = document.getElementById('loading-overlay');
        const messageModal = document.getElementById('message-modal');
        const messageModalTitle = document.getElementById('message-modal-title');
        const messageModalContent = document.getElementById('message-modal-content');
        const messageModalCloseBtn = document.getElementById('message-modal-close-btn');
        const toastContainer = document.getElementById('toast-container');
        const creditCardAlertsDiv = document.getElementById('credit-card-alerts');
        const userAliasInput = document.getElementById('user-alias'); // Input para el alias
        const saveAliasBtn = document.getElementById('save-alias-btn'); // Botón para guardar alias


        // Referencias a los spans de error de validación
        const authEmailError = document.getElementById('auth-email-error');
        const authPasswordError = document.getElementById('auth-password-error');
        const transactionDateError = document.getElementById('transaction-date-error');
        const transactionDescriptionError = document.getElementById('transaction-description-error');
        const transactionCategoryError = document.getElementById('transaction-category-error');
        const transactionBankError = document.getElementById('transaction-bank-error');
        const transactionAmountError = document.getElementById('transaction-amount-error');
        const recurringDescriptionError = document.getElementById('recurring-description-error');
        const recurringAmountError = document.getElementById('recurring-amount-error');
        const recurringCategoryError = document.getElementById('recurring-category-error');
        const recurringBankError = document.getElementById('recurring-bank-error');
        const recurringDayError = document.getElementById('recurring-day-error');
        const creditCardBankError = document.getElementById('credit-card-bank-error');
        const creditCardDueDateError = document.getElementById('credit-card-due-date-error');
        const creditCardAmountError = document.getElementById('credit-card-amount-error');
        const creditCardRateError = document.getElementById('credit-card-rate-error');
        const creditCardMonthsError = document.getElementById('credit-card-months-error');
        const newCategoryNameError = document.getElementById('new-category-name-error');
        const newBankNameError = document.getElementById('new-bank-name-error');
        const transferDateError = document.getElementById('transfer-date-error');
        const transferFromBankError = document.getElementById('transfer-from-bank-error');
        const transferToBankError = document.getElementById('transfer-to-bank-error');
        const transferAmountError = document.getElementById('transfer-amount-error');
        const userAliasError = document.getElementById('user-alias-error');


        // --- INSTANCIA DEL GRÁFICO ---
        let expensesChartInstance = null;
        let cashFlowChartInstance = null; // Para el nuevo gráfico de flujo de efectivo
        let confirmCallback = null;
        
        // --- INICIALIZACIÓN DE LA APLICACIÓN Y AUTENTICACIÓN ---
        // El loadingOverlay ya está activo por defecto en el HTML
        onAuthStateChanged(auth, async (user) => {
            console.log("[Auth State Changed] Usuario:", user ? user.uid : "null"); // Debugging
            try {
                if (user) {
                    userId = user.uid;
                    // userAliasDisplay.textContent = userId; // Esto ahora se actualizará en renderHeaderAlias
                    isAuthReady = true;
                    hideAuthModal(); // Ocultar modal de autenticación si el usuario está logueado
                    await loadUserDataAndListen(); // Cargar datos del usuario una once autenticado
                    initApp(); // Inicializar la UI de la aplicación
                } else {
                    // Si no hay usuario, intentar iniciar sesión anónimamente (para el entorno Canvas)
                    // o mostrar el modal de autenticación para un entorno real.
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    console.log("[Auth State Changed] initialAuthToken presente:", !!initialAuthToken); // Debugging

                    if (initialAuthToken) {
                        try {
                            await window.signInWithCustomToken(auth, initialAuthToken); // Usar window.signInWithCustomToken
                            console.log("[Auth State Changed] Sesión iniciada con token personalizado."); // Debugging
                        } catch (error) {
                            console.error("[Auth State Changed] Error al iniciar sesión con token personalizado:", error);
                            showMessageModal("Error de Autenticación", "No se pudo iniciar sesión automáticamente. Intenta iniciar sesión manualmente.", "error");
                            showAuthModal(); // Mostrar modal para login/registro manual
                        }
                    } else {
                        // En un entorno real sin token, mostrar el modal de autenticación
                        console.log("[Auth State Changed] No hay token inicial, mostrando modal de autenticación."); // Debugging
                        showAuthModal();
                    }
                    // Asegurarse de que initApp y hideLoading se llamen siempre al final de esta rama
                    initApp(); 
                }
            } catch (error) {
                console.error("[Auth State Changed] Error general en el listener de autenticación:", error); // Debugging
                showMessageModal("Error de Autenticación", "Hubo un problema con la autenticación. Por favor, recarga la página.", "error");
            } finally {
                hideLoading(); // Asegurarse de ocultar la carga SIEMPRE al final del onAuthStateChanged
            }
        }, (error) => {
            console.error("[Auth State Changed] Error en el listener de autenticación:", error); // Debugging
            showMessageModal("Error de Autenticación", "Hubo un problema con la autenticación. Por favor, recarga la página.", "error");
            hideLoading(); // Asegurarse de ocultar la carga en caso de error de listener
        });

        function initApp() {
            console.log("[initApp] Inicializando la aplicación..."); // Debugging
            setupEventListeners();
            setCurrentMonthFilter();
            populateFilterDropdowns();
            renderAll();
            console.log("[initApp] Aplicación inicializada."); // Debugging
        }

        function setupEventListeners() {
            // Eventos de Autenticación
            authForm.addEventListener('submit', handleLogin); // Por defecto, el submit del formulario es login
            registerBtn.addEventListener('click', handleRegister);
            logoutBtn.addEventListener('click', handleLogout);

            // Eventos de la Aplicación
            mainActionBtn.addEventListener('click', handleMainActionClick);
            cancelBtn.addEventListener('click', closeTransactionModal);
            transactionModal.addEventListener('click', (e) => { if (e.target === transactionModal) closeTransactionModal(); });
            transactionForm.addEventListener('submit', handleFormSubmit);
            
            filterMonth.addEventListener('change', () => {
                currentMonthFilterValue = filterMonth.value; // Guardar el valor del filtro
                renderAll();
            });
            filterDescription.addEventListener('input', renderAll);
            filterCategory.addEventListener('change', renderAll);

            document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', (e) => switchTab(e.target.dataset.tab)); });

            document.getElementById('add-category-btn').addEventListener('click', addCategory);
            document.getElementById('add-bank-btn').addEventListener('click', addBank);
            document.getElementById('initiate-new-month-btn').addEventListener('click', initiateNewMonth);
            document.getElementById('reset-data-btn').addEventListener('click', resetAllData);
            
            confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) closeConfirmModal(); });
            confirmModalCancelBtn.addEventListener('click', closeConfirmModal);
            confirmModalConfirmBtn.addEventListener('click', () => { if (typeof confirmCallback === 'function') confirmCallback(); closeConfirmModal(); });

            messageModalCloseBtn.addEventListener('click', closeMessageModal);
            messageModal.addEventListener('click', (e) => { if (e.target === messageModal) closeMessageModal(); });

            document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
            document.getElementById('export-json-btn').addEventListener('click', exportData);
            document.getElementById('import-json-btn').addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', importData);

            creditCardModal.addEventListener('click', (e) => { if (e.target === creditCardModal) closeCreditCardModal(); });
            document.getElementById('credit-card-cancel-btn').addEventListener('click', closeCreditCardModal);
            creditCardForm.addEventListener('submit', handleCreditCardFormSubmit);
            
            // Event listener para cambios en los inputs de la tabla de tarjetas de crédito
            creditCardsTableBody.addEventListener('change', handleCardDataChange);

            openTransferModalBtn.addEventListener('click', openTransferModal);
            transferCancelBtn.addEventListener('click', closeTransferModal);
            transferModal.addEventListener('click', (e) => { if (e.target === transferModal) closeTransferModal(); });
            transferForm.addEventListener('submit', handleTransferFormSubmit);

            recurringCancelBtn.addEventListener('click', closeRecurringExpenseModal);
            recurringExpenseModal.addEventListener('click', (e) => { if (e.target === recurringExpenseModal) closeRecurringExpenseModal(); });
            recurringExpenseForm.addEventListener('submit', handleRecurringExpenseFormSubmit);

            // Nuevo evento para guardar el alias
            saveAliasBtn.addEventListener('click', handleSaveAlias);
        }

        // --- LÓGICA DE AUTENTICACIÓN ---
        function showAuthModal() {
            authModal.classList.add('active');
            document.body.classList.add('auth-modal-active'); // Ocultar contenido principal
            mainContentWrapper.style.display = 'none';
        }

        function hideAuthModal() {
            authModal.classList.remove('active');
            document.body.classList.remove('auth-modal-active');
            mainContentWrapper.style.display = 'block'; // Mostrar contenido principal
        }

        async function handleRegister(e) {
            e.preventDefault();
            clearValidationErrors(); // Limpiar errores previos
            
            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            let isValid = true;
            if (!validateEmail(authEmailInput, authEmailError)) isValid = false;
            if (!validatePassword(authPasswordInput, authPasswordError, 6)) isValid = false;

            if (!isValid) {
                showToast("Por favor, corrige los errores en el formulario.", "error");
                return;
            }

            showButtonLoading(registerBtn);
            console.log("[Auth] Intentando registrar usuario:", email); // Debugging

            try {
                // Acceder a createUserWithEmailAndPassword a través de window
                await window.createUserWithEmailAndPassword(auth, email, password);
                showToast("¡Tu cuenta ha sido creada y has iniciado sesión!", "success");
                // onAuthStateChanged se encargará de ocultar el modal y cargar los datos
            } catch (error) {
                console.error("[Auth] Error de registro:", error); // Debugging
                let errorMessage = "Error al registrar la cuenta. Inténtalo de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este correo electrónico ya está en uso. Intenta iniciar sesión o usa otro correo.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "La contraseña debe tener al menos 6 caracteres.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "El formato del correo electrónico es inválido.";
                }
                showMessageModal("Error de Registro", errorMessage, "error");
            } finally {
                hideButtonLoading(registerBtn);
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            clearValidationErrors(); // Limpiar errores previos

            const email = authEmailInput.value;
            const password = authPasswordInput.value;

            let isValid = true;
            if (!validateEmail(authEmailInput, authEmailError)) isValid = false;
            if (!validateRequired(authPasswordInput, authPasswordError, "La contraseña es obligatoria.")) isValid = false;

            if (!isValid) {
                showToast("Por favor, ingresa tu correo y contraseña.", "error");
                return;
            }

            showButtonLoading(loginBtn);
            console.log("[Auth] Intentando iniciar sesión con:", email); // Debugging

            try {
                // Acceder a signInWithEmailAndPassword a través de window
                await window.signInWithEmailAndPassword(auth, email, password);
                showToast("¡Inicio de Sesión Exitoso! Bienvenido de nuevo.", "success");
                // onAuthStateChanged se encargará de ocultar el modal y cargar los datos
            } catch (error) {
                console.error("[Auth] Error de inicio de sesión:", error); // Debugging
                let errorMessage = "Error al iniciar sesión. Verifica tu correo y contraseña.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Correo electrónico o contraseña incorrectos.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "El formato del correo electrónico es inválido.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Demasiados intentos fallidos. Inténtalo de nuevo más tarde.";
                }
                showMessageModal("Error de Inicio de Sesión", errorMessage, "error");
            } finally {
                hideButtonLoading(loginBtn);
            }
        }

        async function handleLogout() {
            openConfirmModal('Cerrar Sesión', '¿Estás seguro de que quieres cerrar tu sesión?', async () => {
                showButtonLoading(logoutBtn); // Mostrar spinner en el botón de cerrar sesión
                console.log("[Auth] Intentando cerrar sesión..."); // Debugging
                try {
                    // Acceder a signOut a través de window
                    await window.signOut(auth);
                    // onAuthStateChanged se encargará de mostrar el modal de autenticación
                    showToast("Sesión Cerrada Exitosamente.", "info");
                    // Limpiar el estado local para evitar mostrar datos del usuario anterior
                    appState = {
                        transactions: [], categories: [], banks: [], descriptions: [], recurringExpenses: [], creditCards: [], openingBalance: 0, userAlias: null,
                    };
                    renderAll(); // Limpiar la UI
                } catch (error) {
                    console.error("[Auth] Error al cerrar sesión:", error); // Debugging
                    showMessageModal("Error al Cerrar Sesión", "No se pudo cerrar la sesión. Por favor, inténtalo de nuevo.", "error");
                } finally {
                    hideButtonLoading(logoutBtn); // Ocultar spinner
                }
            });
        }

        // --- LÓGICA DE DATOS (FIREBASE) ---

        async function loadUserDataAndListen() {
            if (!userId) {
                console.warn("[Firestore] No hay ID de usuario para cargar datos. Esto no debería ocurrir si isAuthReady es true.");
                hideLoading(); // Asegurarse de ocultar la carga
                return;
            }
            console.log(`[Firestore] Cargando datos para el usuario: ${userId}`); // Debugging

            // Usamos el projectId global para construir la ruta del appId
            const appId = firebaseProjectId; 
            if (!appId) { // Doble verificación por si acaso
                console.error("[Firestore] ERROR: appId no disponible al cargar datos.");
                showMessageModal("Error de Configuración", "El ID del proyecto Firebase no está disponible. Recarga la página o verifica tu configuración.", "error");
                hideLoading();
                return;
            }

            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
            const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
            const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);

            // Escuchar cambios en las preferencias del usuario
            onSnapshot(userDocRef, async (docSnap) => {
                console.log("[Firestore] onSnapshot preferences fired."); // Debugging
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState.categories = data.categories || [];
                    appState.banks = data.banks || [];
                    appState.descriptions = data.descriptions || [];
                    appState.openingBalance = data.openingBalance || 0;
                    appState.userAlias = data.userAlias || null; // Cargar el alias
                    // Futura mejora: Cargar presupuestos por categoría
                    // appState.categoryBudgets = data.categoryBudgets || {};
                    console.log("[Firestore] Preferencias cargadas:", appState.categories, appState.banks, appState.descriptions, appState.openingBalance, appState.userAlias); // Debugging
                } else {
                    console.log("[Firestore] Documento de preferencias no existe, inicializando con valores por defecto."); // Debugging
                    // Si el documento no existe, inicializar con valores por defecto y guardarlos
                    appState.categories = ['Sueldo', 'Comida', 'Transporte', 'Servicios', 'Ocio', 'Transferencia Interna', 'Vivienda', 'Entretenimiento'];
                    appState.banks = ['Efectivo', 'Banco Principal', 'Tarjeta de Crédito'];
                    appState.descriptions = ['Pago de Nómina', 'Compra de Supermercado', 'Factura de Electricidad', 'Alquiler', 'Suscripción a Netflix'];
                    appState.openingBalance = 0;
                    appState.userAlias = null; // Alias por defecto nulo
                    // appState.categoryBudgets = {}; // Inicializar presupuestos
                    // Solo inicializar si el usuario no es anónimo (para evitar crear docs para cada sesión anónima temporal)
                    if (auth.currentUser && !auth.currentUser.isAnonymous) {
                         try {
                            await setDoc(userDocRef, appState);
                            console.log("[Firestore] Preferencias por defecto guardadas."); // Debugging
                         } catch (error) {
                            console.error("[Firestore] Error al guardar preferencias por defecto:", error); // Debugging
                            showMessageModal("Error de Inicialización", "No se pudieron guardar las preferencias iniciales. Verifica tus reglas de seguridad de Firestore.", "error");
                         }
                    } else {
                        console.log("[Firestore] Usuario anónimo, no se guardan preferencias por defecto automáticamente."); // Debugging
                    }
                }
                if (isAuthReady) { 
                    populateFilterDropdowns();
                    populateModalDropdowns(); // Actualizar dropdowns de modales
                    populateRecurringModalDropdowns(); // Actualizar dropdowns de modales recurrentes
                    populateDescriptionDatalist(); // Actualizar datalist de descripciones
                    populateTransferModalDropdowns(); // Actualizar dropdowns de transferencia
                    renderConfigurationLists();
                    renderHeaderAlias(); // Actualizar el alias en la cabecera
                    renderAll(); 
                }
            }, (error) => {
                console.error("[Firestore] Error al escuchar preferencias del usuario:", error); // Debugging
                showMessageModal("Error de Carga de Preferencias", "Hubo un problema al cargar tus preferencias. Verifica tu conexión a internet o inténtalo más tarde. Asegúrate de que tus reglas de seguridad de Firestore permitan la lectura de 'user_data/preferences'.", "error");
                // No ocultar hideLoading aquí, ya se hace en el finally del onAuthStateChanged
            });

            // Escuchar cambios en las transacciones
            onSnapshot(transactionsColRef, (snapshot) => {
                console.log("[Firestore] onSnapshot transactions fired."); // Debugging
                appState.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("[Firestore] Transacciones cargadas:", appState.transactions.length); // Debugging
                if (isAuthReady) renderAll();
            }, (error) => {
                console.error("[Firestore] Error al escuchar transacciones:", error); // Debugging
                showMessageModal("Error de Carga de Transacciones", "Hubo un problema al cargar tus transacciones. Verifica tu conexión a internet o inténtalo más tarde. Asegúrate de que tus reglas de seguridad de Firestore permitan la lectura de 'transactions'.", "error");
                // No ocultar hideLoading aquí, ya se hace en el finally del onAuthStateChanged
            });

            // Escuchar cambios en los gastos recurrentes
            onSnapshot(recurringExpensesColRef, (snapshot) => {
                console.log("[Firestore] onSnapshot recurringExpenses fired."); // Debugging
                appState.recurringExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("[Firestore] Gastos recurrentes cargados:", appState.recurringExpenses.length); // Debugging
                if (isAuthReady) renderAll();
            }, (error) => {
                console.error("[Firestore] Error al escuchar gastos recurrentes:", error); // Debugging
                showMessageModal("Error de Carga de Gastos Recurrentes", "Hubo un problema al cargar tus gastos recurrentes. Verifica tu conexión a internet o inténtalo más tarde. Asegúrate de que tus reglas de seguridad de Firestore permitan la lectura de 'recurringExpenses'.", "error");
                // No ocultar hideLoading aquí, ya se hace en el finally del onAuthStateChanged
            });

            // Escuchar cambios en las tarjetas de crédito
            onSnapshot(creditCardsColRef, (snapshot) => {
                console.log("[Firestore] onSnapshot creditCards fired."); // Debugging
                appState.creditCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("[Firestore] Tarjetas de crédito cargadas:", appState.creditCards.length); // Debugging
                if (isAuthReady) renderAll();
            }, (error) => {
                console.error("[Firestore] Error al escuchar tarjetas de crédito:", error); // Debugging
                showMessageModal("Error de Carga de Tarjetas de Crédito", "Hubo un problema al cargar tus tarjetas de crédito. Verifica tu conexión a internet o inténtalo más tarde. Asegúrate de que tus reglas de seguridad de Firestore permitan la lectura de 'creditCards'.", "error");
                // No ocultar hideLoading aquí, ya se hace en el finally del onAuthStateChanged
            });
        }
        
        function getFilteredTransactions() {
            const selectedMonth = filterMonth.value;
            const descriptionFilter = filterDescription.value.toLowerCase();
            const categoryFilter = filterCategory.value;

            return appState.transactions.filter(t => {
                const transactionMonth = t.date.substring(0, 7);
                const matchesMonth = !selectedMonth || transactionMonth === selectedMonth;
                const matchesDescription = t.description.toLowerCase().includes(descriptionFilter);
                const matchesCategory = !categoryFilter || t.category === categoryFilter;
                return matchesMonth && matchesDescription && matchesCategory;
            }).sort((a, b) => new Date(a.date) - new Date(b.date));
        }

        // --- RENDERIZADO ---

        function renderAll() {
            renderDashboard();
            renderTransactionsTable();
            renderConfigurationLists();
            renderCreditCardAlerts(); // Renderizar alertas de tarjetas
            renderHeaderAlias(); // Asegurarse de que el alias se muestre correctamente
            const activeTabElement = document.querySelector('.tab-pane.active');
            if (activeTabElement) {
                const activeTab = activeTabElement.id;
                if (activeTab === 'reportes-content') renderReports();
                if (activeTab === 'tarjetas-content') renderCreditCardsTable();
                if (activeTab === 'recurrentes-content') renderRecurringExpensesTable();
            }
        }

        function renderHeaderAlias() {
            if (appState.userAlias) {
                userAliasDisplay.textContent = appState.userAlias;
                userAliasInput.value = appState.userAlias; // Cargar el alias en el input de configuración
            } else {
                userAliasDisplay.textContent = `Usuario (${userId ? userId.substring(0, 8) + '...' : 'Cargando...'})`; // Mostrar parte del UID si no hay alias
                userAliasInput.value = ''; // Limpiar el input si no hay alias
            }
        }

        function renderDashboard() {
            const transactionsForMonth = getFilteredTransactions();
            const income = transactionsForMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactionsForMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            // Calcular el balance total de todas las transacciones
            const totalIncome = appState.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = appState.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const currentBalance = appState.openingBalance + totalIncome - totalExpenses;

            document.getElementById('current-balance').textContent = formatCurrency(currentBalance);
            document.getElementById('monthly-income').textContent = formatCurrency(income);
            document.getElementById('monthly-expenses').textContent = formatCurrency(expenses);
        }

        function renderTransactionsTable() {
            const filteredTransactions = getFilteredTransactions();
            transactionsTableBody.innerHTML = '';

            if (filteredTransactions.length === 0) {
                transactionsTableBody.classList.add('hidden');
                noTransactionsMessage.classList.remove('hidden');
            } else {
                transactionsTableBody.classList.remove('hidden');
                noTransactionsMessage.classList.add('hidden');
                filteredTransactions.forEach(t => {
                    const row = document.createElement('tr');
                    let rowClass = '';
                    if (t.category === 'Transferencia Interna') {
                        rowClass = 'bg-blue-50';
                    } else if (t.type === 'income') {
                        rowClass = 'bg-green-50';
                    } else {
                        rowClass = 'bg-red-50';
                    }
                    row.className = rowClass;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(t.date)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${t.description}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${t.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${t.type === 'income' ? 'text-green-600' : 'text-gray-400'}">${t.type === 'income' ? formatCurrency(t.amount) : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${t.type === 'expense' ? 'text-red-600' : 'text-gray-400'}">${t.type === 'expense' ? formatCurrency(t.amount) : '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button data-id="${t.id}" class="edit-btn text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                            <button data-id="${t.id}" class="delete-btn text-red-600 hover:text-red-900">Eliminar</button>
                        </td>
                    `;
                    transactionsTableBody.appendChild(row);
                });
            }
            
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openTransactionModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteTransaction(e.target.dataset.id)));
        }
        
        function renderReports() {
            const transactionsForMonth = getFilteredTransactions();
            const expensesByCategory = transactionsForMonth
                .filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    acc[t.category] = (acc[t.category] || 0) + t.amount;
                    return acc;
                }, {});

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);
            const totalExpenses = data.reduce((sum, amount) => sum + amount, 0);

            const categoryTotalsList = document.getElementById('category-totals-list');
            categoryTotalsList.innerHTML = '';
            if (labels.length > 0) {
                const sortedCategories = Object.entries(expensesByCategory).sort(([,a],[,b]) => b-a);
                sortedCategories.forEach(([category, amount]) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center text-sm p-2 bg-gray-50 rounded-md';
                    item.innerHTML = `
                        <span class="text-gray-700">${category}</span>
                        <span class="font-medium text-red-500">${formatCurrency(amount)}</span>
                    `;
                    categoryTotalsList.appendChild(item);
                });
            } else {
                categoryTotalsList.innerHTML = '<p class="text-gray-500 text-center">No hay gastos para mostrar en este período.</p>';
            }
            document.getElementById('total-expenses-report').textContent = formatCurrency(totalExpenses);

            const ctx = document.getElementById('expenses-chart').getContext('2d');
            if (expensesChartInstance) expensesChartInstance.destroy();
            expensesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gastos por Categoría',
                        data: data,
                        backgroundColor: ['#ef4444', '#f97316', '#f59e0b', '#eab308', '#84cc16', '#22c55e', '#10b981', '#14b8a6', '#06b6d4', '#0ea5e9', '#3b82f6', '#6366f1', '#8b5cf6', '#a855f7', '#d946ef', '#ec4899'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: `Distribución de Gastos para ${formatMonthYear(filterMonth.value)}` }
                    }
                }
            });

            // Nuevo gráfico: Flujo de Efectivo Mensual
            renderCashFlowChart();
        }

        function renderCashFlowChart() {
            const allMonths = [...new Set(appState.transactions.map(t => t.date.substring(0, 7)))].sort();
            const monthlyData = allMonths.map(month => {
                const transactionsInMonth = appState.transactions.filter(t => t.date.startsWith(month));
                const income = transactionsInMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const expenses = transactionsInMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                return { month, income, expenses };
            });

            const labels = monthlyData.map(d => formatMonthYear(d.month));
            const incomeData = monthlyData.map(d => d.income);
            const expensesData = monthlyData.map(d => d.expenses);

            const ctx = document.getElementById('cash-flow-chart').getContext('2d');
            if (cashFlowChartInstance) cashFlowChartInstance.destroy();
            cashFlowChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: incomeData,
                            backgroundColor: '#22c55e', // green-500
                            borderColor: '#16a34a',
                            borderWidth: 1
                        },
                        {
                            label: 'Gastos',
                            data: expensesData,
                            backgroundColor: '#ef4444', // red-500
                            borderColor: '#dc2626',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Ingresos vs. Gastos por Mes' }
                    },
                    scales: {
                        x: { stacked: false },
                        y: { stacked: false, beginAtZero: true }
                    }
                }
            });
        }

        function renderCreditCardAlerts() {
            creditCardAlertsDiv.innerHTML = '';
            const today = new Date();
            const alerts = [];

            appState.creditCards.forEach(card => {
                const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDate);
                if (today.getDate() > card.dueDate) {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                }
                const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));

                if (daysDiff >= 0 && daysDiff <= 5) {
                    let message = `¡Atención! El pago de tu tarjeta ${card.bank} vence en ${daysDiff} día(s). Monto: ${formatCurrency(card.amount)}.`;
                    if (daysDiff === 0) {
                        message = `¡Atención! El pago de tu tarjeta ${card.bank} vence HOY. Monto: ${formatCurrency(card.amount)}.`;
                    }
                    alerts.push(message);
                }
            });

            if (alerts.length > 0) {
                alerts.forEach(alertText => {
                    const p = document.createElement('p');
                    p.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-2 mb-1 rounded-md shadow-sm';
                    p.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>${alertText}`;
                    creditCardAlertsDiv.appendChild(p);
                });
            }
        }


        // --- MODALES Y NOTIFICACIONES ---

        function showLoading() {
            loadingOverlay.classList.add('active');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('active');
        }

        /**
         * Muestra un modal de mensaje con título, contenido y tipo.
         * @param {string} title - Título del modal.
         * @param {string} message - Contenido del mensaje.
         * @param {'info'|'success'|'error'} type - Tipo de mensaje para estilos (info por defecto).
         */
        function showMessageModal(title, message, type = 'info') {
            messageModalTitle.textContent = title;
            messageModalContent.textContent = message;
            
            // Limpiar clases de tipo previas
            messageModalTitle.classList.remove('text-blue-600', 'text-green-600', 'text-red-600');
            messageModalContent.classList.remove('text-blue-700', 'text-green-700', 'text-red-700');
            messageModal.querySelector('.mx-auto.flex').classList.remove('bg-blue-100', 'bg-green-100', 'bg-red-100');
            messageModal.querySelector('.mx-auto.flex svg').classList.remove('text-blue-600', 'text-green-600', 'text-red-600');

            let iconSvg = '';
            switch (type) {
                case 'success':
                    messageModalTitle.classList.add('text-green-600');
                    messageModalContent.classList.add('text-green-700');
                    messageModal.querySelector('.mx-auto.flex').classList.add('bg-green-100');
                    messageModal.querySelector('.mx-auto.flex svg').classList.add('text-green-600');
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
                case 'error':
                    messageModalTitle.classList.add('text-red-600');
                    messageModalContent.classList.add('text-red-700');
                    messageModal.querySelector('.mx-auto.flex').classList.add('bg-red-100');
                    messageModal.querySelector('.mx-auto.flex svg').classList.add('text-red-600');
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
                case 'info':
                default:
                    messageModalTitle.classList.add('text-blue-600');
                    messageModalContent.classList.add('text-blue-700');
                    messageModal.querySelector('.mx-auto.flex').classList.add('bg-blue-100');
                    messageModal.querySelector('.mx-auto.flex svg').classList.add('text-blue-600');
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
            }
            messageModal.querySelector('.mx-auto.flex').innerHTML = iconSvg; // Actualizar el icono
            messageModal.classList.add('active');
        }

        function closeMessageModal() {
            messageModal.classList.remove('active');
        }

        /**
         * Muestra una notificación "toast" temporal.
         * @param {string} message - Mensaje a mostrar.
         * @param {'success'|'error'|'info'} type - Tipo de notificación.
         * @param {number} duration - Duración en milisegundos (por defecto 3000).
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let iconSvg = '';
            switch (type) {
                case 'success':
                    iconSvg = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
                case 'error':
                    iconSvg = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
                case 'info':
                default:
                    iconSvg = '<svg class="toast-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
                    break;
            }
            toast.innerHTML = `${iconSvg}<span>${message}</span>`;
            toastContainer.appendChild(toast);

            // Forzar reflow para la animación
            void toast.offsetWidth; 
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function openConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-modal-title').textContent = title;
            document.getElementById('confirm-modal-message').textContent = message;
            confirmCallback = onConfirm;
            confirmModal.classList.add('active');
        }

        function closeConfirmModal() {
            confirmModal.classList.remove('active');
            confirmCallback = null;
        }

        function openTransactionModal(id = null) {
            transactionForm.reset();
            clearValidationErrors(); // Limpiar errores al abrir el modal
            populateModalDropdowns();
            populateDescriptionDatalist();
            if (id) {
                const transaction = appState.transactions.find(t => t.id === id);
                if (transaction) {
                    document.getElementById('modal-title').textContent = 'Editar Transacción';
                    Object.assign(document.getElementById('transaction-id'), { value: transaction.id });
                    Object.assign(document.getElementById('transaction-date'), { value: transaction.date });
                    Object.assign(document.getElementById('transaction-description'), { value: transaction.description });
                    Object.assign(document.getElementById('transaction-category'), { value: transaction.category });
                    Object.assign(document.getElementById('transaction-bank'), { value: transaction.bank });
                    Object.assign(document.getElementById('transaction-amount'), { value: transaction.amount });
                    document.querySelector(`input[name="transaction-type"]:checked`).checked = false; // Desmarcar actual
                    document.querySelector(`input[name="transaction-type"][value="${transaction.type}"]`).checked = true;
                } else {
                    showMessageModal("Error", "Transacción no encontrada.", "error");
                    closeTransactionModal();
                    return;
                }
            } else {
                document.getElementById('modal-title').textContent = 'Registrar Transacción';
                document.getElementById('transaction-id').value = '';
                document.getElementById('transaction-date').valueAsDate = new Date();
                document.querySelector('input[name="transaction-type"][value="income"]').checked = true; // Por defecto a ingreso
            }
            transactionModal.classList.add('active');
        }

        function closeTransactionModal() {
            transactionModal.classList.remove('active');
            clearValidationErrors(); // Limpiar errores al cerrar el modal
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            clearValidationErrors(); // Limpiar errores previos

            const id = document.getElementById('transaction-id').value;
            const description = toTitleCase(document.getElementById('transaction-description').value.trim());
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const date = document.getElementById('transaction-date').value;
            const category = document.getElementById('transaction-category').value;
            const bank = document.getElementById('transaction-bank').value;
            const type = document.querySelector('input[name="transaction-type"]:checked').value;

            let isValid = true;
            if (!validateRequired(document.getElementById('transaction-date'), transactionDateError, "La fecha es obligatoria.")) isValid = false;
            if (!validateRequired(document.getElementById('transaction-description'), transactionDescriptionError, "La descripción es obligatoria.")) isValid = false;
            if (!validateRequired(document.getElementById('transaction-category'), transactionCategoryError, "La categoría es obligatoria.")) isValid = false;
            if (!validateRequired(document.getElementById('transaction-bank'), transactionBankError, "El banco/cuenta es obligatorio.")) isValid = false;
            if (!validatePositiveNumber(document.getElementById('transaction-amount'), transactionAmountError, "El monto debe ser un número positivo.")) isValid = false;
            // No es necesario validar el tipo de transacción, ya que siempre se selecciona uno por defecto

            if (!isValid) {
                showToast("Por favor, corrige los errores en el formulario.", "error");
                return;
            }

            showButtonLoading(document.getElementById('save-transaction-btn')); // Mostrar spinner en el botón
            const appId = firebaseProjectId; 
            const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

            const newTransactionData = {
                date: date,
                description: description,
                category: category,
                bank: bank,
                amount: amount,
                type: type,
            };

            try {
                if (id) {
                    console.log("[Firestore] Actualizando transacción:", id); // Debugging
                    await setDoc(doc(transactionsColRef, id), newTransactionData, { merge: true });
                    showToast("Transacción actualizada exitosamente.", "success");
                } else {
                    console.log("[Firestore] Añadiendo nueva transacción."); // Debugging
                    const newDocRef = doc(transactionsColRef);
                    await setDoc(newDocRef, { ...newTransactionData, id: newDocRef.id }); 
                    showToast("Transacción registrada exitosamente.", "success");
                }

                // Actualizar la lista de descripciones si es una nueva
                const isNewDescription = description && !appState.descriptions.some(d => d.toLowerCase() === description.toLowerCase());
                if (isNewDescription) {
                    openConfirmModal(
                        'Guardar Descripción',
                        `La descripción "${description}" es nueva. ¿Deseas guardarla para usarla en el futuro?`,
                        async () => {
                            const updatedDescriptions = [...appState.descriptions, description].sort((a, b) => a.localeCompare(b));
                            console.log("[Firestore] Guardando nueva descripción:", description); // Debugging
                            await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                            showToast(`Descripción "${description}" guardada.`, "info");
                            // appState.descriptions se actualizará automáticamente por el listener onSnapshot
                        }
                    );
                }
                closeTransactionModal();
            } catch (error) {
                console.error("[Firestore] Error al guardar transacción:", error); // Debugging
                showMessageModal("Error al Guardar Transacción", "No se pudo guardar la transacción. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(document.getElementById('save-transaction-btn')); // Ocultar spinner
            }
        }

        async function deleteTransaction(id) {
            openConfirmModal('Eliminar Transacción', '¿Estás seguro de que quieres eliminar esta transacción?', async () => {
                showLoading(); // Usar overlay global para acciones irreversibles
                const appId = firebaseProjectId; 
                const transactionDocRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                console.log("[Firestore] Eliminando transacción:", id); // Debugging
                try {
                    await deleteDoc(transactionDocRef);
                    showToast("Transacción eliminada exitosamente.", "success");
                } catch (error) {
                    console.error("[Firestore] Error al eliminar transacción:", error); // Debugging
                    showMessageModal("Error al Eliminar", "No se pudo eliminar la transacción. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }
        
        function openTransferModal() {
            closeTransactionModal();
            transferForm.reset();
            clearValidationErrors(); // Limpiar errores
            populateTransferModalDropdowns();
            document.getElementById('transfer-date').valueAsDate = new Date();
            transferModal.classList.add('active');
        }

        function closeTransferModal() {
            transferModal.classList.remove('active');
            clearValidationErrors(); // Limpiar errores
        }

        async function handleTransferFormSubmit(e) {
            e.preventDefault();
            clearValidationErrors(); // Limpiar errores previos

            const fromBank = document.getElementById('transfer-from-bank').value;
            const toBank = document.getElementById('transfer-to-bank').value;
            const amount = parseFloat(document.getElementById('transfer-amount').value);
            const date = document.getElementById('transfer-date').value;

            let isValid = true;
            if (!validateRequired(document.getElementById('transfer-date'), transferDateError, "La fecha es obligatoria.")) isValid = false;
            if (!validateRequired(document.getElementById('transfer-from-bank'), transferFromBankError, "La cuenta de origen es obligatoria.")) isValid = false;
            if (!validateRequired(document.getElementById('transfer-to-bank'), transferToBankError, "La cuenta de destino es obligatoria.")) isValid = false;
            if (!validatePositiveNumber(document.getElementById('transfer-amount'), transferAmountError, "El monto debe ser un número positivo.")) isValid = false;
            
            if (fromBank === toBank) {
                showError(transferToBankError, "La cuenta de origen y destino no pueden ser la misma.");
                isValid = false;
            }

            if (!isValid) {
                showToast("Por favor, corrige los errores en el formulario de transferencia.", "error");
                return;
            }

            showButtonLoading(document.getElementById('confirm-transfer-btn'));
            const appId = firebaseProjectId; 
            const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);

            const batch = writeBatch(db);
            const newExpenseDocRef = doc(transactionsColRef); 
            const newIncomeDocRef = doc(transactionsColRef); 
            
            const expenseTransaction = {
                id: newExpenseDocRef.id, date: date, description: `Transferencia a ${toBank}`,
                category: 'Transferencia Interna', bank: fromBank, amount: amount, type: 'expense',
            };
            const incomeTransaction = {
                id: newIncomeDocRef.id, date: date, description: `Transferencia desde ${fromBank}`,
                category: 'Transferencia Interna', bank: toBank, amount: amount, type: 'income',
            };

            batch.set(newExpenseDocRef, expenseTransaction);
            batch.set(newIncomeDocRef, incomeTransaction);
            console.log("[Firestore] Registrando transferencia interna."); // Debugging

            try {
                await batch.commit();
                closeTransferModal();
                showToast("Transferencia registrada exitosamente.", "success");
            } catch (error) {
                console.error("[Firestore] Error al registrar transferencia:", error); // Debugging
                showMessageModal("Error al Registrar Transferencia", "No se pudo registrar la transferencia. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(document.getElementById('confirm-transfer-btn'));
            }
        }

        // --- CONFIGURACIÓN ---

        function renderConfigurationLists() {
            const categoryList = document.getElementById('category-list');
            const bankList = document.getElementById('bank-list');
            const descriptionListConfig = document.getElementById('description-list-config');
            
            categoryList.innerHTML = '';
            bankList.innerHTML = '';
            descriptionListConfig.innerHTML = '';

            appState.categories.forEach(cat => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-gray-50 p-2 rounded-lg";
                li.innerHTML = `<span>${cat}</span><button data-name="${cat}" class="delete-category-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
                categoryList.appendChild(li);
            });

            appState.banks.forEach(bank => {
                const li = document.createElement('li');
                 li.className = "flex justify-between items-center bg-gray-50 p-2 rounded-lg";
                li.innerHTML = `<span>${bank}</span><button data-name="${bank}" class="delete-bank-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
                bankList.appendChild(li);
            });
            
            if (appState.descriptions.length === 0) {
                descriptionListConfig.innerHTML = '<p class="text-gray-500 text-sm p-2">No hay descripciones guardadas.</p>';
            } else {
                appState.descriptions.forEach(desc => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between items-center bg-gray-50 p-2 rounded-lg";
                    li.innerHTML = `<span class="truncate pr-2">${desc}</span><button data-name="${desc}" class="delete-description-btn text-red-500 hover:text-red-700 text-sm flex-shrink-0">Eliminar</button>`;
                    descriptionListConfig.appendChild(li);
                });
            }

            document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCategory(e.target.dataset.name)));
            document.querySelectorAll('.delete-bank-btn').forEach(btn => btn.addEventListener('click', (e) => deleteBank(e.target.dataset.name)));
            document.querySelectorAll('.delete-description-btn').forEach(btn => btn.addEventListener('click', (e) => deleteDescription(e.target.dataset.name)));
        }

        async function addCategory() {
            clearValidationErrors(); // Limpiar errores previos
            const input = document.getElementById('new-category-name');
            const name = toTitleCase(input.value.trim());

            let isValid = true;
            if (!validateRequired(input, newCategoryNameError, "El nombre de la categoría es obligatorio.")) isValid = false;
            
            if (name && appState.categories.some(c => c.toLowerCase() === name.toLowerCase())) {
                showError(newCategoryNameError, `La categoría "${name}" ya existe.`);
                isValid = false;
            }

            if (!isValid) {
                showToast("Por favor, corrige los errores para añadir la categoría.", "error");
                return;
            }

            showButtonLoading(document.getElementById('add-category-btn'));
            const appId = firebaseProjectId; 
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

            try {
                const updatedCategories = [...appState.categories, name].sort((a, b) => a.localeCompare(b));
                console.log("[Firestore] Añadiendo categoría:", name); // Debugging
                await updateDoc(userDocRef, { categories: updatedCategories });
                input.value = '';
                showToast(`Categoría "${name}" añadida.`, "success");
            } catch (error) {
                console.error("[Firestore] Error al añadir categoría:", error); // Debugging
                showMessageModal("Error al Añadir Categoría", "No se pudo añadir la categoría. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(document.getElementById('add-category-btn'));
            }
        }
        
        async function deleteCategory(name) {
            openConfirmModal('Eliminar Categoría', `¿Seguro que quieres eliminar la categoría "${name}"? Esto no eliminará las transacciones existentes con esta categoría.`, async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                console.log("[Firestore] Eliminando categoría:", name); // Debugging
                try {
                    const updatedCategories = appState.categories.filter(c => c !== name);
                    await updateDoc(userDocRef, { categories: updatedCategories });
                    showToast(`Categoría "${name}" eliminada.`, "success");
                } catch (error) {
                    console.error("[Firestore] Error al eliminar categoría:", error); // Debugging
                    showMessageModal("Error al Eliminar Categoría", "No se pudo eliminar la categoría. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        async function addBank() {
            clearValidationErrors(); // Limpiar errores previos
            const input = document.getElementById('new-bank-name');
            const name = toTitleCase(input.value.trim());

            let isValid = true;
            if (!validateRequired(input, newBankNameError, "El nombre del banco/cuenta es obligatorio.")) isValid = false;

            if (name && appState.banks.some(b => b.toLowerCase() === name.toLowerCase())) {
                showError(newBankNameError, `El banco/cuenta "${name}" ya existe.`);
                isValid = false;
            }

            if (!isValid) {
                showToast("Por favor, corrige los errores para añadir el banco/cuenta.", "error");
                return;
            }

            showButtonLoading(document.getElementById('add-bank-btn'));
            const appId = firebaseProjectId; 
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

            try {
                const updatedBanks = [...appState.banks, name].sort((a, b) => a.localeCompare(b));
                console.log("[Firestore] Añadiendo banco:", name); // Debugging
                await updateDoc(userDocRef, { banks: updatedBanks });
                input.value = '';
                showToast(`Banco/Cuenta "${name}" añadido.`, "success");
            } catch (error) {
                console.error("[Firestore] Error al añadir banco:", error); // Debugging
                showMessageModal("Error al Añadir Banco/Cuenta", "No se pudo añadir el banco/cuenta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(document.getElementById('add-bank-btn'));
            }
        }
        
        async function deleteBank(name) {
            openConfirmModal('Eliminar Banco/Cuenta', `Al eliminar "${name}", también se eliminará la tarjeta de crédito asociada, si existe. ¿Deseas continuar?`, async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
                console.log("[Firestore] Eliminando banco:", name); // Debugging

                try {
                    const batch = writeBatch(db);

                    // Eliminar el banco de la lista de bancos
                    const updatedBanks = appState.banks.filter(b => b !== name);
                    batch.update(userDocRef, { banks: updatedBanks });

                    // Eliminar tarjetas de crédito asociadas
                    const cardsToDelete = appState.creditCards.filter(cc => cc.bank === name);
                    cardsToDelete.forEach(card => {
                        batch.delete(doc(creditCardsColRef, card.id));
                    });

                    await batch.commit();
                    showToast(`Banco/Cuenta "${name}" y tarjetas asociadas eliminados.`, "success");
                } catch (error) {
                    console.error("[Firestore] Error al eliminar banco/cuenta:", error); // Debugging
                    showMessageModal("Error al Eliminar Banco/Cuenta", "No se pudo eliminar el banco/cuenta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }
        
        async function deleteDescription(name) {
             openConfirmModal('Eliminar Descripción', `¿Seguro que quieres eliminar la descripción guardada "${name}"?`, async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                console.log("[Firestore] Eliminando descripción:", name); // Debugging
                try {
                    const updatedDescriptions = appState.descriptions.filter(d => d !== name);
                    await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                    showToast(`Descripción "${name}" eliminada.`, "success");
                } catch (error) {
                    console.error("[Firestore] Error al eliminar descripción:", error); // Debugging
                    showMessageModal("Error al Eliminar Descripción", "No se pudo eliminar la descripción. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        async function handleSaveAlias() {
            clearValidationErrors(); // Limpiar errores previos
            const alias = userAliasInput.value.trim();

            let isValid = true;
            if (!validateRequired(userAliasInput, userAliasError, "El alias no puede estar vacío.")) isValid = false;
            // Puedes añadir más validaciones aquí, como longitud máxima, caracteres permitidos, etc.

            if (!isValid) {
                showToast("Por favor, corrige los errores para guardar el alias.", "error");
                return;
            }

            showButtonLoading(saveAliasBtn);
            const appId = firebaseProjectId;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

            try {
                await updateDoc(userDocRef, { userAlias: alias });
                appState.userAlias = alias; // Actualizar el estado local inmediatamente
                renderHeaderAlias(); // Actualizar la cabecera
                showToast("Alias guardado exitosamente.", "success");
            } catch (error) {
                console.error("[Firestore] Error al guardar alias:", error);
                showMessageModal("Error al Guardar Alias", "No se pudo guardar el alias. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(saveAliasBtn);
            }
        }

        async function initiateNewMonth() {
            openConfirmModal('Iniciar Nuevo Mes', 'Se generarán automáticamente los gastos recurrentes y se archivarán las transacciones del mes actual. ¿Estás seguro?', async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                console.log("[Firestore] Iniciando nuevo mes..."); // Debugging

                try {
                    const totalIncome = appState.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                    const totalExpenses = appState.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                    const finalBalance = appState.openingBalance + totalIncome - totalExpenses;

                    const batch = writeBatch(db);

                    // Eliminar todas las transacciones actuales
                    const currentTransactionsSnapshot = await getDocs(transactionsColRef);
                    currentTransactionsSnapshot.docs.forEach(d => {
                        batch.delete(doc(transactionsColRef, d.id));
                    });

                    // Actualizar el saldo inicial
                    batch.update(userDocRef, { openingBalance: finalBalance });
                    
                    // Generar gastos recurrentes para el nuevo mes
                    const now = new Date();
                    const currentMonth = now.getMonth();
                    const nextMonthDate = new Date(now.getFullYear(), currentMonth + 1, 1);
                    const nextMonthString = nextMonthDate.toISOString().substring(0, 7);

                    appState.recurringExpenses.forEach(re => {
                        const transactionDate = new Date(nextMonthDate.getFullYear(), nextMonthDate.getMonth(), re.day);
                        const newTransactionRef = doc(transactionsColRef); 
                        const newTransaction = {
                            id: newTransactionRef.id, 
                            date: transactionDate.toISOString().split('T')[0],
                            description: re.description,
                            category: re.category,
                            bank: re.bank,
                            amount: re.amount,
                            type: 'expense',
                        };
                        batch.set(newTransactionRef, newTransaction); 
                    });
                    
                    await batch.commit();
                    setCurrentMonthFilter(nextMonthString); 
                    switchTab('registros'); 
                    showToast("¡Nuevo mes iniciado y gastos recurrentes generados!", "success");
                } catch (error) {
                    console.error("[Firestore] Error al iniciar nuevo mes:", error); // Debugging
                    showMessageModal("Error al Iniciar Nuevo Mes", "No se pudo iniciar el nuevo mes. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        async function resetAllData() {
            openConfirmModal('Reiniciar Todos los Datos', '¡ADVERTENCIA! Esta acción es irreversible. Eliminará permanentemente TODOS tus datos (transacciones, recurrentes, tarjetas, categorías, bancos, descripciones). ¿Estás absolutamente seguro de que quieres continuar?', async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
                const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
                console.log("[Firestore] Reiniciando todos los datos..."); // Debugging

                try {
                    const batch = writeBatch(db);

                    // Eliminar el documento de preferencias
                    batch.delete(userDocRef);

                    // Eliminar todas las transacciones
                    const transactionsSnapshot = await getDocs(transactionsColRef);
                    transactionsSnapshot.docs.forEach(d => batch.delete(doc(transactionsColRef, d.id)));

                    // Eliminar todos los gastos recurrentes
                    const recurringSnapshot = await getDocs(recurringExpensesColRef);
                    recurringSnapshot.docs.forEach(d => batch.delete(doc(recurringExpensesColRef, d.id)));

                    // Eliminar todas las tarjetas de crédito
                    const creditCardsSnapshot = await getDocs(creditCardsColRef);
                    creditCardsSnapshot.docs.forEach(d => batch.delete(doc(creditCardsColRef, d.id)));

                    await batch.commit();

                    // Reinicializar el estado de la aplicación localmente con valores por defecto
                    appState = {
                        transactions: [], 
                        categories: ['Sueldo', 'Comida', 'Transporte', 'Servicios', 'Ocio', 'Transferencia Interna', 'Vivienda', 'Entretenimiento'],
                        banks: ['Efectivo', 'Banco Principal', 'Tarjeta de Crédito'], 
                        descriptions: ['Pago de Nómina', 'Compra de Supermercado', 'Factura de Electricidad', 'Alquiler', 'Suscripción a Netflix'],
                        recurringExpenses: [],
                        creditCards: [], 
                        openingBalance: 0,
                        userAlias: null, // Resetear alias
                    };
                    // Guardar los valores por defecto en Firestore para el usuario actual
                    await setDoc(userDocRef, appState);
                    
                    initApp(); // Re-inicializar la app
                    showMessageModal("Datos Reiniciados", "Todos tus datos han sido eliminados y la aplicación ha sido reiniciada con valores por defecto.", "success");
                } catch (error) {
                    console.error("[Firestore] Error al reiniciar todos los datos:", error); // Debugging
                    showMessageModal("Error al Reiniciar Datos", "No se pudieron reiniciar todos los datos. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        // --- GASTOS RECURRENTES ---

        function renderRecurringExpensesTable() {
            recurringExpensesTableBody.innerHTML = '';
            const table = recurringExpensesTableBody.closest('table');
            
            if (appState.recurringExpenses.length === 0) {
                table.querySelector('tbody').classList.add('hidden');
                table.querySelector('tfoot').classList.add('hidden');
                noRecurringExpensesMessage.classList.remove('hidden');
                return;
            }
            
            table.querySelector('tbody').classList.remove('hidden');
            table.querySelector('tfoot').classList.remove('hidden');
            noRecurringExpensesMessage.classList.add('hidden');

            appState.recurringExpenses.forEach(re => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${re.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">${formatCurrency(re.amount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${re.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${re.bank}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-500">${re.day}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button data-id="${re.id}" class="edit-recurring-btn text-blue-600 hover:text-blue-900 mr-3">Editar</button>
                        <button data-id="${re.id}" class="delete-recurring-btn text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                recurringExpensesTableBody.appendChild(row);
            });

            const totalRecurring = appState.recurringExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            document.getElementById('recurring-total').textContent = formatCurrency(totalRecurring);

            document.querySelectorAll('.edit-recurring-btn').forEach(btn => btn.addEventListener('click', (e) => openRecurringExpenseModal(e.target.dataset.id)));
            document.querySelectorAll('.delete-recurring-btn').forEach(btn => btn.addEventListener('click', (e) => deleteRecurringExpense(e.target.dataset.id)));
        }

        function openRecurringExpenseModal(id = null) {
            recurringExpenseForm.reset();
            clearValidationErrors(); // Limpiar errores
            populateRecurringModalDropdowns();
            populateDescriptionDatalist();
            if (id) {
                const expense = appState.recurringExpenses.find(re => re.id === id);
                if (expense) {
                    document.getElementById('recurring-modal-title').textContent = 'Editar Gasto Recurrente';
                    document.getElementById('recurring-expense-id').value = expense.id;
                    document.getElementById('recurring-description').value = expense.description;
                    document.getElementById('recurring-amount').value = expense.amount;
                    document.getElementById('recurring-category').value = expense.category;
                    document.getElementById('recurring-bank').value = expense.bank;
                    document.getElementById('recurring-day').value = expense.day;
                } else {
                    showMessageModal("Error", "Gasto recurrente no encontrado.", "error");
                    closeRecurringExpenseModal();
                    return;
                }
            } else {
                document.getElementById('recurring-modal-title').textContent = 'Añadir Gasto Recurrente';
                document.getElementById('recurring-expense-id').value = '';
            }
            recurringExpenseModal.classList.add('active');
        }

        function closeRecurringExpenseModal() {
            recurringExpenseModal.classList.remove('active');
            clearValidationErrors(); // Limpiar errores
        }

        async function handleRecurringExpenseFormSubmit(e) {
            e.preventDefault();
            clearValidationErrors(); // Limpiar errores previos

            const id = document.getElementById('recurring-expense-id').value;
            const description = toTitleCase(document.getElementById('recurring-description').value.trim());
            const amount = parseFloat(document.getElementById('recurring-amount').value);
            const category = document.getElementById('recurring-category').value;
            const bank = document.getElementById('recurring-bank').value;
            const day = parseInt(document.getElementById('recurring-day').value);
            
            let isValid = true;
            if (!validateRequired(document.getElementById('recurring-description'), recurringDescriptionError, "La descripción es obligatoria.")) isValid = false;
            if (!validatePositiveNumber(document.getElementById('recurring-amount'), recurringAmountError, "El monto debe ser un número positivo.")) isValid = false;
            if (!validateRequired(document.getElementById('recurring-category'), recurringCategoryError, "La categoría es obligatoria.")) isValid = false;
            if (!validateRequired(document.getElementById('recurring-bank'), recurringBankError, "El banco/cuenta es obligatorio.")) isValid = false;
            if (!validateDayOfMonth(document.getElementById('recurring-day'), recurringDayError, "El día de pago debe ser entre 1 y 31.")) isValid = false;

            if (!isValid) {
                showToast("Por favor, corrige los errores en el formulario.", "error");
                return;
            }

            showButtonLoading(document.getElementById('save-recurring-btn'));
            const appId = firebaseProjectId; 
            const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);

            const newRecurringExpenseData = {
                description: description,
                amount: amount,
                category: category,
                bank: bank,
                day: day,
            };

            try {
                if (id) {
                    console.log("[Firestore] Actualizando gasto recurrente:", id); // Debugging
                    await setDoc(doc(recurringExpensesColRef, id), newRecurringExpenseData, { merge: true });
                    showToast("Gasto recurrente actualizado exitosamente.", "success");
                } else {
                    console.log("[Firestore] Añadiendo nuevo gasto recurrente."); // Debugging
                    const newDocRef = doc(recurringExpensesColRef);
                    await setDoc(newDocRef, { ...newRecurringExpenseData, id: newDocRef.id });
                    showToast("Gasto recurrente añadido exitosamente.", "success");
                }

                // Actualizar la lista de descripciones si es una nueva
                const isNewDescription = description && !appState.descriptions.some(d => d.toLowerCase() === description.toLowerCase());
                if (isNewDescription) {
                    const updatedDescriptions = [...appState.descriptions, description].sort((a, b) => a.localeCompare(b));
                    console.log("[Firestore] Guardando nueva descripción para recurrente:", description); // Debugging
                    await updateDoc(userDocRef, { descriptions: updatedDescriptions });
                    showToast(`Descripción "${description}" guardada.`, "info");
                }
                closeRecurringExpenseModal();
            } catch (error) {
                console.error("[Firestore] Error al guardar gasto recurrente:", error); // Debugging
                showMessageModal("Error al Guardar Gasto Recurrente", "No se pudo guardar el gasto recurrente. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(document.getElementById('save-recurring-btn'));
            }
        }

        async function deleteRecurringExpense(id) {
            openConfirmModal('Eliminar Gasto Recurrente', '¿Estás seguro? Esto no afectará a transacciones ya creadas.', async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const recurringExpenseDocRef = doc(db, `artifacts/${appId}/users/${userId}/recurringExpenses`, id);
                console.log("[Firestore] Eliminando gasto recurrente:", id); // Debugging
                try {
                    await deleteDoc(recurringExpenseDocRef);
                    showToast("Gasto recurrente eliminado exitosamente.", "success");
                } catch (error) {
                    console.error("[Firestore] Error al eliminar gasto recurrente:", error); // Debugging
                    showMessageModal("Error al Eliminar Gasto Recurrente", "No se pudo eliminar el gasto recurrente. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        // --- TARJETAS DE CRÉDITO ---

        function renderCreditCardsTable() {
            creditCardsTableBody.innerHTML = '';
            if (appState.creditCards.length === 0) {
                creditCardsTableBody.classList.add('hidden');
                noCreditCardsMessage.classList.remove('hidden');
                return;
            }
            
            creditCardsTableBody.classList.remove('hidden');
            noCreditCardsMessage.classList.add('hidden');

            appState.creditCards.forEach(card => {
                const row = document.createElement('tr');
                row.dataset.cardId = card.id;

                const today = new Date();
                const nextDueDate = new Date(today.getFullYear(), today.getMonth(), card.dueDate);
                if (today.getDate() > card.dueDate) {
                    nextDueDate.setMonth(nextDueDate.getMonth() + 1);
                }
                const daysDiff = Math.ceil((nextDueDate - today) / (1000 * 60 * 60 * 24));
                
                let bgColor = 'bg-white';
                if (daysDiff >= 0 && daysDiff <= 2) { // Vence hoy o en los próximos 2 días
                    bgColor = 'bg-red-100';
                } else if (daysDiff > 2 && daysDiff <= 5) { // Vence en 3 a 5 días
                    bgColor = 'bg-yellow-100';
                }
                row.className = bgColor;

                const monthlyPayment = calculateMonthlyPayment(card.amount, card.rate, card.months);

                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${card.bank}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">Día ${card.dueDate} de cada mes</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm"><input type="number" class="table-input card-data-input" data-field="amount" value="${card.amount}" step="0.01"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm"><input type="number" class="table-input card-data-input" data-field="rate" value="${card.rate}" step="0.01"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm"><input type="number" class="table-input card-data-input" data-field="months" value="${card.months}" min="1"></td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-semibold text-blue-600 monthly-payment-cell">${formatCurrency(monthlyPayment)}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button class="delete-card-btn text-red-600 hover:text-red-900" data-id="${card.id}">Eliminar</button>
                    </td>
                `;
                creditCardsTableBody.appendChild(row);
            });

            document.querySelectorAll('.delete-card-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCreditCard(e.target.dataset.id)));
        }

        async function handleCardDataChange(e) {
            if (!e.target.classList.contains('card-data-input')) return;
            
            const inputElement = e.target;
            const field = inputElement.dataset.field;
            let value = parseFloat(inputElement.value);

            // Validación en línea para los campos de la tabla
            let isValid = true;
            if (field === 'amount' || field === 'rate' || field === 'months') {
                if (isNaN(value) || value < 0) {
                    showToast(`El valor para "${field}" debe ser un número positivo.`, "error");
                    inputElement.value = inputElement.defaultValue; // Revertir al valor original
                    isValid = false;
                }
                if (field === 'months' && value < 1) {
                     showToast("Los meses para saldar deben ser al menos 1.", "error");
                     inputElement.value = inputElement.defaultValue;
                     isValid = false;
                }
            }

            if (!isValid) return; // Detener si la validación falla

            showButtonLoading(inputElement); // Mostrar spinner en el input (simulado)
            const appId = firebaseProjectId; 
            const creditCardDocRef = doc(db, `artifacts/${appId}/users/${userId}/creditCards`, e.target.closest('tr').dataset.cardId);

            try {
                console.log(`[Firestore] Actualizando tarjeta ${e.target.closest('tr').dataset.cardId}, campo ${field}: ${value}`); // Debugging
                await updateDoc(creditCardDocRef, { [field]: value });
                showToast("Datos de tarjeta actualizados.", "success");
                // El onSnapshot se encargará de re-renderizar la tabla y actualizar los cálculos
            } catch (error) {
                console.error("[Firestore] Error al actualizar datos de la tarjeta:", error); // Debugging
                showMessageModal("Error al Actualizar Tarjeta", "No se pudieron actualizar los datos de la tarjeta. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(inputElement); // Ocultar spinner
            }
        }

        function calculateMonthlyPayment(principal, annualRate, months) {
            if (principal <= 0 || months <= 0) return 0;
            if (annualRate <= 0) return principal / months;

            const monthlyRate = (annualRate / 100) / 12;
            const payment = (principal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -months));
            return payment;
        }

        async function deleteCreditCard(cardId) {
            openConfirmModal('Eliminar Tarjeta', `¿Seguro que quieres eliminar esta tarjeta?`, async () => {
                showLoading(); // Usar overlay global
                const appId = firebaseProjectId; 
                const creditCardDocRef = doc(db, `artifacts/${appId}/users/${userId}/creditCards`, cardId);
                console.log("[Firestore] Eliminando tarjeta de crédito:", cardId); // Debugging
                try {
                    await deleteDoc(creditCardDocRef);
                    showToast("Tarjeta de crédito eliminada exitosamente.", "success");
                } catch (error) {
                    console.error("[Firestore] Error al eliminar tarjeta de crédito:", error); // Debugging
                    showMessageModal("Error al Eliminar Tarjeta", "No se pudo eliminar la tarjeta de crédito. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
                } finally {
                    hideLoading();
                }
            });
        }

        function openCreditCardModal() {
            creditCardForm.reset();
            clearValidationErrors(); // Limpiar errores
            creditCardModal.classList.add('active');
        }

        function closeCreditCardModal() {
            creditCardModal.classList.remove('active');
            clearValidationErrors(); // Limpiar errores
        }

        async function handleCreditCardFormSubmit(e) {
            e.preventDefault();
            clearValidationErrors(); // Limpiar errores previos
            
            const bank = toTitleCase(document.getElementById('credit-card-bank').value.trim());
            const dueDate = parseInt(document.getElementById('credit-card-due-date').value);
            const amount = parseFloat(document.getElementById('credit-card-amount').value);
            const rate = parseFloat(document.getElementById('credit-card-rate').value);
            const months = parseInt(document.getElementById('credit-card-months').value);

            let isValid = true;
            if (!validateRequired(document.getElementById('credit-card-bank'), creditCardBankError, "El nombre del banco es obligatorio.")) isValid = false;
            if (!validateDayOfMonth(document.getElementById('credit-card-due-date'), creditCardDueDateError, "El día de pago debe ser entre 1 y 31.")) isValid = false;
            if (!validatePositiveNumber(document.getElementById('credit-card-amount'), creditCardAmountError, "El monto adeudado debe ser un número positivo.")) isValid = false;
            if (!validatePositiveNumber(document.getElementById('credit-card-rate'), creditCardRateError, "La tasa de interés debe ser un número positivo.")) isValid = false;
            if (!validatePositiveNumber(document.getElementById('credit-card-months'), creditCardMonthsError, "Los meses para saldar deben ser un número positivo.")) isValid = false;

            if (bank && appState.creditCards.some(c => c.bank.toLowerCase() === bank.toLowerCase())) {
                showError(creditCardBankError, 'Ya existe una tarjeta para este banco.');
                isValid = false;
            }

            if (!isValid) {
                showToast("Por favor, corrige los errores en el formulario.", "error");
                return;
            }

            showButtonLoading(document.getElementById('save-credit-card-btn'));
            const appId = firebaseProjectId; 
            const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);

            const newCardData = {
                bank: bank,
                dueDate: dueDate,
                amount: amount,
                rate: rate,
                months: months
            };
            try {
                console.log("[Firestore] Añadiendo nueva tarjeta de crédito."); // Debugging
                const newDocRef = doc(creditCardsColRef);
                await setDoc(newDocRef, { ...newCardData, id: newDocRef.id });
                closeCreditCardModal();
                showToast("Tarjeta añadida exitosamente.", "success");
            } catch (error) {
                console.error("[Firestore] Error al añadir tarjeta de crédito:", error); // Debugging
                showMessageModal("Error al Añadir Tarjeta", "No se pudo añadir la tarjeta de crédito. Verifica tu conexión a internet y tus reglas de seguridad de Firestore.", "error");
            } finally {
                hideButtonLoading(document.getElementById('save-credit-card-btn'));
            }
        }

        // --- IMPORTAR Y EXPORTAR ---

        function exportToPDF() {
            const doc = new jsPDF();
            const transactions = getFilteredTransactions();
            const monthString = formatMonthYear(filterMonth.value);

            doc.text(`Reporte de Transacciones - ${monthString}`, 14, 16);

            const tableColumn = ["Fecha", "Descripción", "Categoría", "Ingreso", "Gasto"];
            const tableRows = [];

            transactions.forEach(tx => {
                const transactionData = [
                    formatDate(tx.date),
                    tx.description,
                    tx.category,
                    tx.type === 'income' ? formatCurrency(tx.amount) : '-',
                    tx.type === 'expense' ? formatCurrency(tx.amount) : '-'
                ];
                tableRows.push(transactionData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 24,
            });
            
            const finalY = doc.lastAutoTable.finalY || 24;
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            doc.text("Resumen del Mes:", 14, finalY + 10);
            doc.text(`Total Ingresos: ${formatCurrency(income)}`, 14, finalY + 16);
            doc.text(`Total Gastos: ${formatCurrency(expenses)}`, 14, finalY + 22);
            doc.text(`Balance del Mes: ${formatCurrency(income - expenses)}`, 14, finalY + 28);

            doc.save(`reporte_${filterMonth.value}.pdf`);
            showToast("Reporte PDF generado exitosamente.", "success");
        }

        function exportData() {
            // Exportar el estado actual de appState (que ya está sincronizado con Firestore)
            const dataToExport = {
                transactions: appState.transactions,
                categories: appState.categories,
                banks: appState.banks,
                descriptions: appState.descriptions,
                recurringExpenses: appState.recurringExpenses,
                creditCards: appState.creditCards,
                openingBalance: appState.openingBalance,
                userAlias: appState.userAlias, // Exportar el alias
                // Futura mejora: Exportar presupuestos por categoría
                // categoryBudgets: appState.categoryBudgets,
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.download = `presupuesto_datos_${new Date().toISOString().split('T')[0]}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
            showToast("Datos exportados a JSON exitosamente.", "success");
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedState = JSON.parse(e.target.result);
                    openConfirmModal('Importar Datos', 'Esto reemplazará todos los datos actuales. ¿Deseas continuar?', async () => {
                        showLoading(); // Usar overlay global
                        const appId = firebaseProjectId; 
                        const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/user_data/preferences`);
                        const transactionsColRef = collection(db, `artifacts/${appId}/users/${userId}/transactions`);
                        const recurringExpensesColRef = collection(db, `artifacts/${appId}/users/${userId}/recurringExpenses`);
                        const creditCardsColRef = collection(db, `artifacts/${appId}/users/${userId}/creditCards`);
                        console.log("[Firestore] Importando datos..."); // Debugging

                        try {
                            const batch = writeBatch(db);

                            // Eliminar datos existentes
                            const currentTransactions = await getDocs(transactionsColRef);
                            currentTransactions.docs.forEach(d => batch.delete(doc(transactionsColRef, d.id)));
                            const currentRecurring = await getDocs(recurringExpensesColRef);
                            currentRecurring.docs.forEach(d => batch.delete(doc(recurringExpensesColRef, d.id)));
                            const currentCreditCards = await getDocs(creditCardsColRef);
                            currentCreditCards.docs.forEach(d => batch.delete(doc(creditCardsColRef, d.id)));
                            
                            // Escribir nuevas preferencias
                            batch.set(userDocRef, {
                                categories: importedState.categories || [],
                                banks: importedState.banks || [],
                                descriptions: importedState.descriptions || [],
                                openingBalance: importedState.openingBalance || 0,
                                userAlias: importedState.userAlias || null, // Importar el alias
                                // Futura mejora: Importar presupuestos por categoría
                                // categoryBudgets: importedState.categoryBudgets || {},
                            });

                            // Escribir nuevas transacciones
                            importedState.transactions.forEach(tx => {
                                const newTxRef = doc(transactionsColRef); 
                                batch.set(newTxRef, { ...tx, id: newTxRef.id }); 
                            });

                            // Escribir nuevos gastos recurrentes
                            importedState.recurringExpenses.forEach(re => {
                                const newReRef = doc(recurringExpensesColRef);
                                batch.set(newReRef, { ...re, id: newReRef.id });
                            });

                            // Escribir nuevas tarjetas de crédito
                            importedState.creditCards.forEach(cc => {
                                const newCcRef = doc(creditCardsColRef);
                                batch.set(newCcRef, { ...cc, id: newCcRef.id });
                            });

                            await batch.commit();
                            showMessageModal("Importación Exitosa", "Los datos han sido importados correctamente.", "success");
                            // onSnapshot se encargará de actualizar appState y el renderizado
                        } catch (error) {
                            console.error("[Firestore] Error al importar datos a Firebase:", error); // Debugging
                            showMessageModal("Error de Importación", "Hubo un error al importar los datos. Asegúrate de que el archivo sea válido y tus reglas de seguridad de Firestore permitan la escritura.", "error");
                        } finally {
                            hideLoading();
                        }
                    });
                } catch (error) {
                    showMessageModal('Error de Archivo', 'El archivo seleccionado no es un archivo de datos válido. Asegúrate de que sea un JSON con el formato correcto.', "error");
                }
            };
            reader.readAsText(file);
            importFileInput.value = ''; // Limpiar el input de archivo
        }

        // --- UTILIDADES Y VALIDACIÓN ---
        
        /**
         * Convierte una cadena a formato Title Case.
         * @param {string} str - La cadena a convertir.
         * @returns {string} La cadena en Title Case.
         */
        function toTitleCase(str) {
            if (!str) return '';
            return str.toLowerCase().split(' ').map(word => {
                return word.charAt(0).toUpperCase() + word.slice(1);
            }).join(' ');
        }

        /**
         * Muestra un spinner dentro de un botón y deshabilita el botón.
         * @param {HTMLElement} buttonElement - El botón HTML.
         */
        function showButtonLoading(buttonElement) {
            const spinner = buttonElement.querySelector('.btn-spinner');
            if (spinner) {
                spinner.classList.remove('hidden');
            }
            buttonElement.disabled = true;
            // Opcional: guardar el texto original y reemplazarlo
            // buttonElement.dataset.originalText = buttonElement.textContent;
            // buttonElement.textContent = '';
        }

        /**
         * Oculta el spinner de un botón y lo habilita.
         * @param {HTMLElement} buttonElement - El botón HTML.
         */
        function hideButtonLoading(buttonElement) {
            const spinner = buttonElement.querySelector('.btn-spinner');
            if (spinner) {
                spinner.classList.add('hidden');
            }
            buttonElement.disabled = false;
            // Opcional: restaurar el texto original
            // if (buttonElement.dataset.originalText) {
            //     buttonElement.textContent = buttonElement.dataset.originalText;
            // }
        }

        /**
         * Muestra un mensaje de error para un campo de entrada.
         * @param {HTMLElement} errorElement - El elemento span donde se muestra el error.
         * @param {string} message - El mensaje de error.
         */
        function showError(errorElement, message) {
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('active');
            }
        }

        /**
         * Oculta un mensaje de error para un campo de entrada.
         * @param {HTMLElement} errorElement - El elemento span del error.
         */
        function hideError(errorElement) {
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.classList.remove('active');
            }
        }

        /**
         * Limpia todos los mensajes de error de validación en la página.
         */
        function clearValidationErrors() {
            document.querySelectorAll('.input-error-message').forEach(el => hideError(el));
        }

        /**
         * Valida que un campo requerido no esté vacío.
         * @param {HTMLInputElement|HTMLSelectElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {string} errorMessage - Mensaje si está vacío.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validateRequired(inputElement, errorElement, errorMessage) {
            if (!inputElement.value.trim()) {
                showError(errorElement, errorMessage);
                return false;
            }
            hideError(errorElement);
            return true;
        }

        /**
         * Valida que un campo numérico sea positivo.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {string} errorMessage - Mensaje si no es positivo.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validatePositiveNumber(inputElement, errorElement, errorMessage) {
            const value = parseFloat(inputElement.value);
            if (isNaN(value) || value <= 0) {
                showError(errorElement, errorMessage);
                return false;
            }
            hideError(errorElement);
            return true;
        }

        /**
         * Valida un formato de correo electrónico básico.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validateEmail(inputElement, errorElement) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!inputElement.value.trim()) {
                showError(errorElement, "El correo electrónico es obligatorio.");
                return false;
            }
            if (!emailRegex.test(inputElement.value.trim())) {
                showError(errorElement, "Formato de correo electrónico inválido.");
                return false;
            }
            hideError(errorElement);
            return true;
        }

        /**
         * Valida la longitud mínima de una contraseña.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {number} minLength - Longitud mínima requerida.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validatePassword(inputElement, errorElement, minLength) {
            if (!inputElement.value.trim()) {
                showError(errorElement, "La contraseña es obligatoria.");
                return false;
            }
            if (inputElement.value.length < minLength) {
                showError(errorElement, `La contraseña debe tener al menos ${minLength} caracteres.`);
                return false;
            }
            hideError(errorElement);
            return true;
        }

        /**
         * Valida que un día del mes esté entre 1 y 31.
         * @param {HTMLInputElement} inputElement - El elemento de entrada.
         * @param {HTMLElement} errorElement - El elemento span para el error.
         * @param {string} errorMessage - Mensaje si no es válido.
         * @returns {boolean} True si es válido, false en caso contrario.
         */
        function validateDayOfMonth(inputElement, errorElement, errorMessage) {
            const value = parseInt(inputElement.value);
            if (isNaN(value) || value < 1 || value > 31) {
                showError(errorElement, errorMessage);
                return false;
            }
            hideError(errorElement);
            return true;
        }


        function populateFilterDropdowns() {
            const categoryFilter = document.getElementById('filter-category');
            const currentVal = currentMonthFilterValue; 
            categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';
            appState.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = currentVal;
        }
        
        function populateModalDropdowns() {
            const categorySelect = document.getElementById('transaction-category');
            const bankSelect = document.getElementById('transaction-bank');
            categorySelect.innerHTML = '';
            bankSelect.innerHTML = '';
            appState.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
             appState.banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankSelect.appendChild(option);
            });
        }
        
        function populateRecurringModalDropdowns() {
            const categorySelect = document.getElementById('recurring-category');
            const bankSelect = document.getElementById('recurring-bank');
            categorySelect.innerHTML = '';
            bankSelect.innerHTML = '';
            appState.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
             appState.banks.forEach(bank => {
                const option = document.createElement('option');
                option.value = bank;
                option.textContent = bank;
                bankSelect.appendChild(option);
            });
        }

        function populateDescriptionDatalist() {
            const datalist = document.getElementById('description-list');
            datalist.innerHTML = '';
            appState.descriptions.forEach(desc => {
                const option = document.createElement('option');
                option.value = desc;
                datalist.appendChild(option);
            });
        }

        function populateTransferModalDropdowns() {
            const fromBankSelect = document.getElementById('transfer-from-bank');
            const toBankSelect = document.getElementById('transfer-to-bank');
            fromBankSelect.innerHTML = '';
            toBankSelect.innerHTML = '';
            appState.banks.forEach(bank => {
                const option1 = document.createElement('option');
                option1.value = bank;
                option1.textContent = bank;
                fromBankSelect.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = bank;
                option2.textContent = bank;
                toBankSelect.appendChild(option2);
            });
        }

        function setCurrentMonthFilter(month = null) {
            if (month) {
                filterMonth.value = month;
            } else if (!currentMonthFilterValue) { 
                const now = new Date();
                const year = now.getFullYear();
                const monthValue = (now.getMonth() + 1).toString().padStart(2, '0');
                filterMonth.value = `${year}-${monthValue}`;
            }
            currentMonthFilterValue = filterMonth.value; 
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.add('hidden');
                pane.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            const activePane = document.getElementById(`${tabName}-content`);
            activePane.classList.remove('hidden');
            activePane.classList.add('active');
            document.querySelector(`button[data-tab="${tabName}"]`).classList.add('active');

            // Actualizar botón de acción principal
            if (tabName === 'registros') {
                mainActionBtnText.textContent = 'Registrar Transacción';
                mainActionBtn.classList.remove('hidden');
            } else if (tabName === 'recurrentes') {
                mainActionBtnText.textContent = 'Añadir Gasto Recurrente';
                mainActionBtn.classList.remove('hidden');
            } else if (tabName === 'tarjetas') {
                mainActionBtnText.textContent = 'Añadir Tarjeta';
                mainActionBtn.classList.remove('hidden');
            } else {
                mainActionBtn.classList.add('hidden'); // Ocultar si no es una de las pestañas de acción
            }
            
            renderAll();
        }

        function handleMainActionClick() {
            const activeTab = document.querySelector('.tab-button.active').dataset.tab;
            if (activeTab === 'registros') {
                openTransactionModal();
            } else if (activeTab === 'recurrentes') {
                openRecurringExpenseModal();
            } else if (activeTab === 'tarjetas') {
                openCreditCardModal();
            }
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function formatDate(dateString) {
             const date = new Date(dateString + 'T00:00:00');
             return date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatMonthYear(dateString) {
            if (!dateString) return "el período actual";
            const [year, month] = dateString.split('-');
            const date = new Date(year, month - 1);
            return date.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
        }
    });
    </script>
<script>
        const contributionTypeSelect = document.getElementById('contribution401kType');
        const contributionValueInput = document.getElementById('contribution401kValue');
        const contributionLabel = document.getElementById('contribution401kLabel');

        contributionTypeSelect.addEventListener('change', () => {
            if (contributionTypeSelect.value === 'percent') {
                contributionLabel.textContent = 'Valor 401(k) (%)';
                contributionValueInput.value = "5";
            } else {
                contributionLabel.textContent = 'Valor 401(k) ($)';
                contributionValueInput.value = "100";
            }
        });


        document.getElementById('calculateBtn').addEventListener('click', () => {
            // --- 1. OBTENER DATOS DEL USUARIO ---
            const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            const totalHours = parseFloat(document.getElementById('hoursWorked').value) || 0;
            const filingStatus = document.getElementById('filingStatus').value;
            const contribution401kType = document.getElementById('contribution401kType').value;
            const contribution401kValue = parseFloat(document.getElementById('contribution401kValue').value) || 0;
            const medicalDeduction = parseFloat(document.getElementById('medicalDeduction').value) || 0;
            const dentalDeduction = parseFloat(document.getElementById('dentalDeduction').value) || 0;
            const visionDeduction = parseFloat(document.getElementById('visionDeduction').value) || 0;
            const loan401k = parseFloat(document.getElementById('loan401k').value) || 0;
            
            const payPeriods = 26; // Quincenal
            const regularHoursThreshold = 80;

            // --- 2. CONSTANTES FISCALES 2025 ---
            const FICA_RATES = {
                SOCIAL_SECURITY: 0.062,
                MEDICARE: 0.0145,
            };
            const FEDERAL_TAX = {
                DEDUCTION: { single: 15000, married: 30000 },
                BRACKETS: {
                    single: [
                        { rate: 0.10, upto: 11925 }, { rate: 0.12, upto: 48475 },
                        { rate: 0.22, upto: 103350 }, { rate: 0.24, upto: 197300 },
                        { rate: 0.32, upto: 250525 }, { rate: 0.35, upto: 626350 },
                        { rate: 0.37, upto: Infinity }
                    ],
                    married: [
                        { rate: 0.10, upto: 23850 }, { rate: 0.12, upto: 96950 },
                        { rate: 0.22, upto: 206700 }, { rate: 0.24, upto: 394600 },
                        { rate: 0.32, upto: 501050 }, { rate: 0.35, upto: 751600 },
                        { rate: 0.37, upto: Infinity }
                    ]
                }
            };

            // --- 3. CÁLCULOS PRINCIPALES ---
            
            // Salario Bruto con Overtime
            let regularHours = Math.min(totalHours, regularHoursThreshold);
            let overtimeHours = Math.max(0, totalHours - regularHoursThreshold);
            let overtimeRate = hourlyRate * 1.5;
            let grossPay = (regularHours * hourlyRate) + (overtimeHours * overtimeRate);
            
            // Deducciones Pre-Impuestos (401k Contribution)
            let contribution401kAmount = 0;
            if (contribution401kType === 'percent') {
                contribution401kAmount = grossPay * (contribution401kValue / 100);
            } else {
                contribution401kAmount = contribution401kValue;
            }
            const preTaxDeductions = contribution401kAmount + medicalDeduction + dentalDeduction + visionDeduction;

            // Ingreso Imponible para Impuesto Federal
            const annualTaxableIncome = (grossPay - preTaxDeductions) * payPeriods;
            
            // Calcular Impuesto Federal Anual
            const standardDeduction = FEDERAL_TAX.DEDUCTION[filingStatus];
            const finalTaxableIncome = Math.max(0, annualTaxableIncome - standardDeduction);
            const brackets = FEDERAL_TAX.BRACKETS[filingStatus];
            
            let federalTaxAnnual = 0;
            let incomeLeft = finalTaxableIncome;
            let previousLimit = 0;

            for (const bracket of brackets) {
                if (incomeLeft > 0) {
                    const taxableInBracket = Math.min(incomeLeft, bracket.upto - previousLimit);
                    federalTaxAnnual += taxableInBracket * bracket.rate;
                    incomeLeft -= taxableInBracket;
                    previousLimit = bracket.upto;
                }
            }
            const federalTaxPerPeriod = federalTaxAnnual / payPeriods;

            // Calcular Impuestos FICA (Social Security & Medicare)
            // Se basa en el Salario Bruto total
            const socialSecurityTax = grossPay * FICA_RATES.SOCIAL_SECURITY;
            const medicareTax = grossPay * FICA_RATES.MEDICARE;
            const ficaTaxes = socialSecurityTax + medicareTax;

            // Deducciones Post-Impuestos
            const postTaxDeductions = loan401k;

            // Calcular Salario Neto
            const totalDeductions = preTaxDeductions + federalTaxPerPeriod + ficaTaxes + postTaxDeductions;
            const netPay = grossPay - totalDeductions;

            // --- 4. MOSTRAR RESULTADOS ---
            document.getElementById('results').classList.remove('hidden');
            
            const formatCurrency = (value) => `$${Math.max(0, value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;

            document.getElementById('grossPayResult').textContent = formatCurrency(grossPay);
            document.getElementById('preTaxDeductionsResult').textContent = formatCurrency(preTaxDeductions);
            document.getElementById('federalTaxResult').textContent = formatCurrency(federalTaxPerPeriod);
            document.getElementById('ficaTaxResult').textContent = formatCurrency(ficaTaxes);
            document.getElementById('postTaxDeductionsResult').textContent = formatCurrency(postTaxDeductions);
            document.getElementById('netPayResult').textContent = formatCurrency(netPay);
        });
    </script></body>
</html>
